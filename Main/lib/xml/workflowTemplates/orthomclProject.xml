<workflowGraph name="">

  <constant name="dataDir"></constant> <!-- empty on purpose. dataDir is root workflow data/ dir -->

  <step name="initClusterHomeDir"
        stepClass="ReFlow::StepClasses::InitClusterHomeDir">
  </step>

  <step name="makeRepProteinsDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$dataDir$$/representativeProteomes</paramValue>
  </step>

  <step name="makeSecProteinsDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$dataDir$$/secondaryProteins</paramValue>
  </step>

  <step name="makeTierOneGroupsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$dataDir$$/tierOneGroups</paramValue>
  </step>

  <datasetTemplate class="orthomclClade">
    <prop name="cladeAbbrev"/>

    <step name="${cladeAbbrev}_makeCladeDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$/${cladeAbbrev}</paramValue>
    </step>

    <subgraph name="${cladeAbbrev}_clade_RSRC" xmlFile="loadResource.xml">
      <paramValue name="resourceName">${cladeAbbrev}_orthomclClade_RSRC</paramValue>
      <paramValue name="resourceXmlFileName">OrthoMCL.xml</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$/${cladeAbbrev}</paramValue>
      <depends name="${cladeAbbrev}_makeCladeDir"/>
    </subgraph>

    <step name="${cladeAbbrev}_makeGoodProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeGoodProteins">
      <paramValue name="proteomesDir">$$dataDir$$/${cladeAbbrev}/${cladeAbbrev}_orthomclClade_RSRC/final</paramValue>
      <paramValue name="outputGoodProteinsFile">$$dataDir$$/${cladeAbbrev}/good.fasta</paramValue>
      <paramValue name="outputBadProteinsFile">$$dataDir$$/${cladeAbbrev}/bad.fasta</paramValue>
      <paramValue name="minLength">10</paramValue>
      <paramValue name="maxStopPercent">20</paramValue>
      <depends name="${cladeAbbrev}_clade_RSRC"/>
    </step>

    <step name="${cladeAbbrev}_makeGroupsDir" stepClass="ReFlow::StepClasses::MakeDataDir" excludeIf="${containsOnlyOneOrganism}">
      <paramValue name="dataDir">$$dataDir$$/${cladeAbbrev}/groups</paramValue>
      <depends name="${cladeAbbrev}_makeCladeDir"/>
    </step>

    <step name="${cladeAbbrev}_mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" excludeIf="${containsOnlyOneOrganism}">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/${cladeAbbrev}</paramValue>
      <depends name="${cladeAbbrev}_makeCladeDir"/>
      <depends name="initClusterHomeDir"/>
    </step>

    <subgraph name="${cladeAbbrev}_makeGroups" xmlFile="makeOrthologGroups.xml" excludeIf="${containsOnlyOneOrganism}">
      <paramValue name="parentDataDir">$$dataDir$$/${cladeAbbrev}</paramValue>
      <paramValue name="inputProteinFile">$$dataDir$$/${cladeAbbrev}/good.fasta</paramValue>
      <paramValue name="inputTaxaDir">$$dataDir$$/${cladeAbbrev}/${cladeAbbrev}_orthomclClade_RSRC/final</paramValue>
      <paramValue name="outputGroupsDir">$$dataDir$$/${cladeAbbrev}/groups</paramValue>
      <paramValue name="suffix">${ncbiTaxonId}</paramValue>
      <paramValue name="useExistingSimSeqs">true</paramValue>
      <paramValue name="collapseClades">false</paramValue>
      <depends name="${cladeAbbrev}_makeGoodProteinsFile"/>
      <depends name="${cladeAbbrev}_makeGroupsDir"/>
    </subgraph>

    <!-- adds cladeAbbrev as prefix to all protein ids -->
    <step name="${cladeAbbrev}_makeRepresentativeProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeRepresentativeProteinsFile" excludeIf="${containsOnlyOneOrganism}">
      <paramValue name="inputGroupsDir">$$dataDir$$/${cladeAbbrev}/groups</paramValue>
      <paramValue name="inputProteinsFile">$$dataDir$$/${cladeAbbrev}/good.fasta</paramValue>
      <paramValue name="outputRepresentativeProteinsFile">$$dataDir$$/representativeProteomes/${ncbiTaxonId}.fasta</paramValue>
      <paramValue name="outputGroupsFile">$$dataDir$$/tierOneGroups/${cladeAbbrev}_groupsWithRepFirst</paramValue>
      <paramValue name="proteinIdPrefix">${ncbiTaxonId}</paramValue>
      <depends name="makeRepProteinsDataDir"/>
      <depends name="makeSecProteinsDataDir"/>
      <depends name="${cladeAbbrev}_makeGroups"/>
    </step>

    <!-- if clade contains only one organism add cladeAbbrev as prefix to all protein ids -->
    <step name="${cladeAbbrev}_makeOrganismProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeOrganismProteinsFile" includeIf="${containsOnlyOneOrganism}">
      <paramValue name="inputProteinsFile">$$dataDir$$/${cladeAbbrev}/good.fasta</paramValue>
      <paramValue name="outputProteinsFile">$$dataDir$$/representativeProteomes/${ncbiTaxonId}.fasta</paramValue>
      <paramValue name="proteinIdPrefix">${ncbiTaxonId}</paramValue>
      <depends name="makeRepProteinsDataDir"/>
      <depends name="${cladeAbbrev}_makeGoodProteinsFile"/>
    </step>

  </datasetTemplate>

  <step name="makeFinalGroupsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$dataDir$$/finalGroups</paramValue>
  </step>

  <step name="makeFinalGoodProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeGoodProteins">
    <paramValue name="proteomesDir">$$dataDir$$/representativeProteomes/</paramValue>
    <paramValue name="outputGoodProteinsFile">$$dataDir$$/good.fasta</paramValue>
    <paramValue name="outputBadProteinsFile">$$dataDir$$/bad.fasta</paramValue>
    <paramValue name="minLength">10</paramValue>
    <paramValue name="maxStopPercent">20</paramValue>
    <dependsPattern name="*_makeRepresentativeProteinsFile"/>
  </step>

  <subgraph name="makeFinalGroups" xmlFile="makeOrthologGroups.xml">
    <paramValue name="parentDataDir">$$dataDir$$</paramValue>
    <paramValue name="inputProteinFile">$$dataDir$$/good.fasta</paramValue>
    <paramValue name="inputTaxaDir"></paramValue>
    <paramValue name="outputGroupsDir">$$dataDir$$/finalGroups</paramValue>
    <paramValue name="suffix"></paramValue>
    <paramValue name="useExistingSimSeqs">true</paramValue>
      <paramValue name="collapseClades">true</paramValue>
    <depends name="makeFinalGoodProteinsFile"/>
    <depends name="makeFinalGroupsDir"/>
  </subgraph>

  <step name="mergeSecondaryProteins" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMergeSecondaryProteins">
    <paramValue name="inputRepGroupsFile">$$dataDir$$/finalGroups/orthomclGroups.txt</paramValue>
    <paramValue name="inputTierOneGroupsDir">$$dataDir$$/tierOneGroups</paramValue>
    <paramValue name="outputMergedGroupsFile">$$dataDir$$/finalGroups/finalGroups.txt</paramValue>
    <depends name="makeFinalGroups"/>
  </step>

</workflowGraph>
