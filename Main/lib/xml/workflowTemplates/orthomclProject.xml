<workflowGraph name="">

  <constant name="dataDir"></constant> <!-- intentionally empty. dataDir is root workflow data/ dir -->
  <constant name="tierOneDir">$$dataDir$$/tierOne</constant>
  <constant name="tierOneRepProteinsDir">$$dataDir$$/tierOne/representativeProteomes</constant>
  <constant name="tierOneRepFirstGroupsDir">$$dataDir$$/tierOne/groupsWithRepFirst</constant>
  <constant name="tierTwoDir">$$dataDir$$/tierTwo</constant>

  <step name="initClusterHomeDir"
        stepClass="ReFlow::StepClasses::InitClusterHomeDir">
  </step>

  <step name="makeTierOneDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$tierOneDir$$</paramValue>
  </step>

  <step name="makeRepProteinsDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$tierOneRepProteinsDir$$</paramValue>
  </step>

  <step name="makeTierOneGroupsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$tierOneRepFirstGroupsDir$$</paramValue>
  </step>

  <datasetTemplate class="orthomclClade">
    <prop name="cladeAbbrev"/>

    <step name="${cladeAbbrev}_makeCladeDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$tierOneDir$$/${cladeAbbrev}</paramValue>
      <depends name="makeTierOneDir"/>
   </step>

    <subgraph name="${cladeAbbrev}_clade_RSRC" xmlFile="loadResource.xml">
      <paramValue name="resourceName">${cladeAbbrev}_orthomclClade_RSRC</paramValue>
      <paramValue name="resourceXmlFileName">OrthoMCL.xml</paramValue>
      <paramValue name="parentDataDir">$$tierOneDir$$/${cladeAbbrev}</paramValue>
      <depends name="${cladeAbbrev}_makeCladeDir"/>
    </subgraph>

    <step name="${cladeAbbrev}_makeGoodProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeGoodProteins">
      <paramValue name="proteomesDir">$$tierOneDir$$/${cladeAbbrev}/${cladeAbbrev}_orthomclClade_RSRC/final</paramValue>
      <paramValue name="outputGoodProteinsFile">$$tierOneDir$$/${cladeAbbrev}/good.fasta</paramValue>
      <paramValue name="outputBadProteinsFile">$$tierOneDir$$/${cladeAbbrev}/bad.fasta</paramValue>
      <paramValue name="minLength">10</paramValue>
      <paramValue name="maxStopPercent">20</paramValue>
      <depends name="${cladeAbbrev}_clade_RSRC"/>
    </step>

    <step name="${cladeAbbrev}_makeGroupsDir" stepClass="ReFlow::StepClasses::MakeDataDir" excludeIf="${containsOnlyOneOrganism}">
      <paramValue name="dataDir">$$tierOneDir$$/${cladeAbbrev}/groupsOutput</paramValue>
      <depends name="${cladeAbbrev}_makeCladeDir"/>
    </step>

    <step name="${cladeAbbrev}_mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" excludeIf="${containsOnlyOneOrganism}">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/${cladeAbbrev}</paramValue>
      <depends name="${cladeAbbrev}_makeCladeDir"/>
      <depends name="initClusterHomeDir"/>
    </step>

    <subgraph name="${cladeAbbrev}_makeGroups" xmlFile="makeOrthologGroups.xml" excludeIf="${containsOnlyOneOrganism}">
      <paramValue name="parentDataDir">$$tierOneDir$$/${cladeAbbrev}</paramValue>
      <paramValue name="inputProteinFile">$$dataDir$$/${cladeAbbrev}/good.fasta</paramValue>
      <paramValue name="inputTaxaDir">$$tierOneDir$$/${cladeAbbrev}/${cladeAbbrev}_orthomclClade_RSRC/final</paramValue>
      <paramValue name="outputGroupsDir">$$tierOneDir$$/${cladeAbbrev}/groupsOutput</paramValue>
      <paramValue name="suffix">${ncbiTaxonId}</paramValue>
      <paramValue name="useExistingSimSeqs">true</paramValue>
      <paramValue name="collapseClades">false</paramValue>
      <paramValue name="includeSingletonGroups">true</paramValue>
      <depends name="${cladeAbbrev}_makeGoodProteinsFile"/>
      <depends name="${cladeAbbrev}_makeGroupsDir"/>
    </subgraph>

    <!-- adds cladeAbbrev as prefix to all protein ids -->
    <step name="${cladeAbbrev}_makeRepresentativeProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeRepresentativeProteinsFile" excludeIf="${containsOnlyOneOrganism}">
      <paramValue name="inputGroupsDir">$$tierOneDir$$/${cladeAbbrev}/groupsOutput</paramValue>
      <paramValue name="inputProteinsFile">$$tierOneDir$$/${cladeAbbrev}/good.fasta</paramValue>
      <paramValue name="outputRepresentativeProteinsFile">$$tierOneRepProteinsDir$$/${ncbiTaxonId}.fasta</paramValue>
      <paramValue name="outputGroupsFile">$$tierOneRepFirstGroupdDir$$/${ncbiTaxonId}_groups.txt</paramValue>
      <paramValue name="proteinIdPrefix">${ncbiTaxonId}</paramValue>
      <depends name="makeTierOneGroupsDir"/>
      <depends name="makeRepProteinsDataDir"/>
      <depends name="${cladeAbbrev}_makeGroups"/>
    </step>

    <!-- if clade contains only one organism add cladeAbbrev as prefix to all protein ids -->
    <step name="${cladeAbbrev}_makeOrganismProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeOrganismProteinsFile" includeIf="${containsOnlyOneOrganism}">
      <paramValue name="inputProteinsFile">$$tierOneDir$$/${cladeAbbrev}/good.fasta</paramValue>
      <paramValue name="outputProteinsFile">$$tierOneRepProteinsDir$$/${ncbiTaxonId}.fasta</paramValue>
      <paramValue name="proteinIdPrefix">${ncbiTaxonId}</paramValue>
      <depends name="makeRepProteinsDataDir"/>
      <depends name="${cladeAbbrev}_makeGoodProteinsFile"/>
    </step>

  </datasetTemplate>

  <step name="makeTierTwoDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$tierTwoDir$$</paramValue>
  </step>

  <step name="makeTierTwoGroupsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$tierTwoDir$$/groupsOutput</paramValue>
  </step>

  <step name="makeFinalGoodProteinsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMakeGoodProteins">
    <paramValue name="proteomesDir">$$tierOneRepProteinsDir$$</paramValue>
    <paramValue name="outputGoodProteinsFile">$$tierTwoDir$$/good.fasta</paramValue>
    <paramValue name="outputBadProteinsFile">$$tierTwoDir$$/bad.fasta</paramValue>
    <paramValue name="minLength">10</paramValue>
    <paramValue name="maxStopPercent">20</paramValue>
    <depends name="makeTierTwoDir"/>
    <dependsPattern name="*_makeRepresentativeProteinsFile"/>
  </step>

  <subgraph name="makeFinalGroups" xmlFile="makeOrthologGroups.xml">
    <paramValue name="parentDataDir">$$dataDir$$</paramValue>
    <paramValue name="inputProteinFile">$$dataDir$$/good.fasta</paramValue>
    <paramValue name="inputTaxaDir"></paramValue>
    <paramValue name="outputGroupsDir">$$tierTwoDir$$/groupsOutput</paramValue>
    <paramValue name="suffix"></paramValue>
    <paramValue name="useExistingSimSeqs">true</paramValue>
    <paramValue name="collapseClades">true</paramValue>
    <paramValue name="includeSingletonGroups">true</paramValue>
    <depends name="makeFinalGoodProteinsFile"/>
    <depends name="makeTierTwoGroupsDir"/>
  </subgraph>

  <!-- remove prefixes -->

  <step name="mergeSecondaryProteins" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::OrthomclMergeSecondaryProteins">
    <paramValue name="inputRepGroupsFile">$$tierTwoDir$$/groupsOutput/orthomclGroups.txt</paramValue>
    <paramValue name="inputTierOneGroupsDir">$$tierOneRepFirstGroupsDir$$</paramValue>
    <paramValue name="outputMergedGroupsFile">$$tierTwoDir$$/finalGroups.txt</paramValue>
    <depends name="makeFinalGroups"/>
  </step>

</workflowGraph>
