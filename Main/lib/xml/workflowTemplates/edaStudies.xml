<workflowGraph name="edaStudies">
  <param name="projectName"/>
  <param name="parentDataDir"/>

  <constant name="dataDir">$$parentDataDir$$/edaStudies</constant>

  <step name="makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$dataDir$$</paramValue>
  </step>


  <datasetTemplate class="ISATabPopBio">
    <prop name="projectName"/>
    <prop name="studyName"/>
    <prop name="version"/>
    <prop name="webDisplayOntologyName"/>


    <subgraph name="ISATab_${studyName}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">ISATab_${studyName}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <depends name="makeDataDir"/>
    </subgraph>

    <step name="edaNextflow_${studyName}" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RunPopbioEdaNextflow" stepLoadTypes="edaStudyLoader">
      <paramValue name="datasetName">ISATab_${studyName}_RSRC</paramValue>
      <paramValue name="datasetVersion">${version}</paramValue>
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="workingDir">$$dataDir$$/ISATab_${studyName}_RSRC</paramValue>
      <!-- TODO need to write download files and webservice files -->
      <paramValue name="resultsDir">$$dataDir$$/ISATab_${studyName}_RSRC/results</paramValue>
      <paramValue name="nextflowWorkflow">VEuPathDB/eda-nextflow</paramValue>
      <paramValue name="isGitRepo">true</paramValue>
      <paramValue name="gitBranch">main</paramValue>
      <depends name="ISATab_${studyName}_RSRC"/>
      <!-- TODO why do these not work?
      <dependsGlobal name="edaGlobal.eupathCuratedOntologies.OntologyTerm_popbio_RSRC.runPlugin"/>
      <dependsGlobal name="edaGlobal.taxonomy_RSRC.runPlugin"/>
      -->
    </step>

    <step name="studyCharacteristics_${studyName}"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyCharacteristics">
      <paramValue name="datasetName">ISATab_${studyName}_RSRC</paramValue>
      <paramValue name="file">$GUS_HOME/ontology/General/study_classifications/yaml/popbio.yaml</paramValue>
      <paramValue name="owlFile">$GUS_HOME/ontology/General/study_classifications/classifications.owl</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="edaNextflow_${studyName}"/>
    </step>


  </datasetTemplate>

  <!-- TODO should this be called Popbio megastudy?? -->
  <datasetTemplate class="EDAMegaStudy">
    <prop name="projectName"/>
    <prop name="studyStableId"/>
    <prop name="version"/>
    <prop name="webDisplayOntologyName"/>

    <subgraph name="EDAMegaStudy_${studyStableId}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">EDAMegaStudy_${studyStableId}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <depends name="makeDataDir"/>
      <dependsPattern name="edaNextflow_*"/>
      <dependsPattern name="studyCharacteristics_*"/>
    </subgraph>

    <step name="EDAMegaStudy_${studyStableId}" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RunMegaStudyEdaNextflow" stepLoadTypes="edaStudyLoader">
      <paramValue name="studyStableId">${studyStableId}</paramValue>
      <paramValue name="megaStudyYamlBaseName">megaStudy.yaml</paramValue>
      <paramValue name="datasetName">EDAMegaStudy_${studyStableId}_RSRC</paramValue>
      <paramValue name="datasetVersion">${version}</paramValue>
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="workingDir">$$dataDir$$/EDAMegaStudy_${studyStableId}_RSRC</paramValue>
      <paramValue name="resultsDir">$$dataDir$$/EDAMegaStudy_${studyStableId}_RSRC/results</paramValue>
      <paramValue name="nextflowWorkflow">VEuPathDB/eda-nextflow</paramValue>
      <paramValue name="isGitRepo">true</paramValue>
      <paramValue name="gitBranch">main</paramValue>
      <depends name="EDAMegaStudy_${studyStableId}_RSRC"/>
      <!-- TODO why do these not work?
      <dependsGlobal name="edaGlobal.eupathCuratedOntologies.OntologyTerm_popbio_RSRC.runPlugin"/>
      <dependsGlobal name="edaGlobal.taxonomy_RSRC.runPlugin"/>
      -->
    </step>


  </datasetTemplate>






</workflowGraph>
