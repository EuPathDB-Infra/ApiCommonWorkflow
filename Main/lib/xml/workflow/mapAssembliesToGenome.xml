<workflowGraph name="mapAssembliesToGenome">

    <param name="parentDataDir"/>
    <param name="nickName"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="ncbiTaxonId"/>
    <param name="maxIntronSize"/>
    <param name="assembliesDataDir"/>
    <param name="genomicSeqsDir"/>
    <param name="organismTwoLetterAbbrev"/>
    <param name="queryTable"/>
    <param name="updateAssemblySourceId"/>
    <param name="queryExtDbRlsSpec"/>

    <constant name ="dataDir">$$parentDataDir$$/$$nickName$$</constant>

    <step name="makeDataDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <subgraph name="blatAgainstGenome" xmlFile="blatAgainstGenome.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="maxIntronSize">$$maxIntronSize$$</paramValue>
      <paramValue name="targetDir">$$genomicSeqsDir$$</paramValue>
      <paramValue name="queryFile">$$assembliesDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends name="makeDataDir"/>
    </subgraph>

    <step name="insertBlatAlignment" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertBlatAlignment" stepLoadTypes="plugin">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$queryExtDbRlsSpec$$</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">load</paramValue>
      <paramValue name="percentTop"></paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$assembliesDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends name="blatAgainstGenome"/>
    </step>

    <step name="setBestBlatAlignment" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertBlatAlignment" stepLoadTypes="plugin">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbRlsSpec">$$queryExtDbRlsSpec$$</paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">setbest</paramValue>
      <paramValue name="percentTop">100</paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$assembliesDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends name="insertBlatAlignment"/>
    </step>

   <step name="updateAssemblySourceId"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::UpdateAssemblySourceId" stepLoadTypes="plugin" includeIf="$$updateAssemblySourceId$$">
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="organismTwoLetterAbbrev">$$organismTwoLetterAbbrev$$</paramValue>
      <depends name="setBestBlatAlignment"/>
    </step>
</workflowGraph>
