<workflowGraph name="blatDnaAgainstGenome">
    <param name="dataDir"/>
    <param name="maxIntronSize"/>
    <param name="organismAbbrev"/>
    <param name="targetSeqsDir"/>
    <param name="targetExtDbRlsSpec"/>
    <param name="queryFile"/>
    <param name="queryTable"/>
    <param name="queryExtDbName"/>
    <param name="datasetSpec"/>
    <param name="gusConfigFile"/>
    <param name="projectName"/>

    <constant name="analysisDirectory">$$dataDir$$/analysisDir</constant>
    <constant name="resultsDirectory">$$analysisDirectory$$/results</constant>
    <constant name="blatOutputFileName">blat.psl</constant>

    <step name="makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeAnalysisDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$analysisDirectory$$</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <step name="makeResultDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$resultsDirectory$$</paramValue>
      <depends name="makeAnalysisDir"/>
    </step>

    <step name="makeNextflowConfig" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeBlatNextflowConfig" >
      <paramValue name="maxIntronSize">$$maxIntronSize$$</paramValue>
      <paramValue name="fastaSubsetSize">1</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <paramValue name="queryType">dna</paramValue>
      <paramValue name="dbType">dna</paramValue>
      <paramValue name="databasePath">$$targetSeqsDir$$/genomicSeqs.fa</paramValue>
      <paramValue name="outputDir">$$resultsDirectory$$</paramValue>
      <paramValue name="analysisDir">$$analysisDirectory$$</paramValue>
      <paramValue name="configFileName">nextflow.config</paramValue>
      <paramValue name="outputFileName">$$blatOutputFileName$$</paramValue>
      <depends name="makeResultsDir"/>
    </step>

    <subgraph name="runNextflowOnCluster" xmlFile="runNextflowOnCluster.xml">
      <paramValue name="projectName">$$projectName$$</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="nextflowConfigFile">$$analysisDirectory$$/nextflow.config</paramValue>
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="genomeSpec">$$targetExtDbRlsSpec$$</paramValue> <!-- NAME|version -->
      <paramValue name="isProteomeAnalysis">false</paramValue>
      <paramValue name="datasetSpec">$$datasetSpec$$</paramValue>
      <paramValue name="nextflowWorkflow">VEuPathDB/blat-nextflow</paramValue>
      <paramValue name="analysisDir">$$analysisDirectory$$</paramValue>
      <depends name="makeNextflowConfig"/>
    </subgraph>

    <step name="fixGenomeSourceIdsInBlatResultFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::FixGenomeSourceIdsInBlatResultFile">
      <paramValue name="inputFile">$$resultsDirectory$$/$$blatOutputFileName$$</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <depends name="runNextflowOnCluster"/>
     </step>

    <step name="insertBlatAlignment" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertBlatAlignment" stepLoadTypes="plugin">
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$targetExtDbRlsSpec$$</paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryExtDbName">$$queryExtDbName$$</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="queryIdRegex">>(\\d+)</paramValue>
      <paramValue name="action">load</paramValue>
      <paramValue name="percentTop"></paramValue>
      <paramValue name="blatFile">$$resultsDirectory$$/$$blatOutputFileName$$</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <paramValue name="gusConfigFile">$$gusConfigFile$$</paramValue>
      <depends name="fixGenomeSourceIdsInBlatResultFile"/>
    </step>

    <step name="setBestBlatAlignment" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertBlatAlignment" stepLoadTypes="plugin">
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$targetExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbName">$$queryExtDbName$$</paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="queryIdRegex">>(\\d+)</paramValue> <!-- This is ignored -->
      <paramValue name="action">setbest</paramValue>
      <paramValue name="percentTop">100</paramValue>
      <paramValue name="blatFile">$$dataDir$$/results/out.psl</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <paramValue name="gusConfigFile">$$gusConfigFile$$</paramValue>
      <depends name="insertBlatAlignment"/>
    </step>

</workflowGraph>
