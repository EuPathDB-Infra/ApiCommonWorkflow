<workflowGraph name="epitopesWorkflow">

    <param name="proteinsFile"/>
    <param name="parentDataDir"/>
    <param name="iedbExtDbRlsSpec"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="organismName"/>

    <constant name="dataDir">$$parentDataDir$$/iedb</constant>
    <constant name="proteinsFileSimpleDefline">$$dataDir$$/blastDb/proteinsSimpleDefline.fsa</constant>

    <step name="makeDataDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeBlastDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$/blastDb</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <step name="makeInputDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$/input</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <step name="copyAndCatIedbFiles" stepClass="ApiCommonData::Load::WorkflowSteps::CopyAndCatIedbFiles">
      <paramValue name="inputDirRelativeToDownloadsDir">IEDB_Epitopes_fixed</paramValue>
      <paramValue name="outputDir">$$dataDir$$/input</paramValue>
      <paramValue name="organismName">$$organismName$$</paramValue>
      <depends name="makeInputDir"/>
    </step>

    <step name="formatNcbiBlastFile" stepClass="ApiCommonData::Load::WorkflowSteps::FormatNcbiBlastFile">
      <paramValue name="inputFile">$$proteinsFile$$</paramValue>
      <paramValue name="outputBlastDbDir">$$dataDir$$/blastDb</paramValue>
      <paramValue name="formatterArgs">T</paramValue>
      <depends name="makeBlastDir"/>
    </step>


    <step name="createEpitopeMapFile" stepClass="ApiCommonData::Load::WorkflowSteps::CreateEpitopeMapFile">
      <paramValue name="inputDir">$$dataDir$$/input</paramValue>
      <paramValue name="blastDbDir">$$dataDir$$/blastDb</paramValue>
      <paramValue name="queryDir">$$dataDir$$/fsa</paramValue>
      <paramValue name="proteinsFile">$$proteinsFile$$</paramValue>
      <paramValue name="outputDir">$$dataDir$$/results</paramValue>
      <paramValue name="idRegex">(\\S+)</paramValue>
      <depends name="formatNcbiBlastFile"/>
      <depends name="copyAndCatIedbFiles"/>
    </step>

    <step name="insertEpitopeMapping" stepClass="ApiCommonData::Load::WorkflowSteps::InsertEpitopeMapping" stepLoadTypes="plugin">
      <paramValue name="inputFile">$$dataDir$$/results/IEDBExport.out</paramValue>
      <paramValue name="iedbExtDbRlsSpec">$$iedbExtDbRlsSpec$$</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <depends name="createEpitopeMapFile"/>
    </step>

</workflowGraph>
