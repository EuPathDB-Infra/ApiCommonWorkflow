<workflowGraph name="analyzeRnaSeqOrChipSeqSample">
    <param name="parentDataDir"/>
    <param name="sampleName"/>
    <param name="genomicSeqsDir"/>
    <param name="bowtieGenomicIndexDir"/>
    <param name="bowtieTranscriptIndexDir"/>
    <param name="ssaGeneModelFile"/>
    <param name="shortSeqsFile"/>
    <param name="genomicSeqsFile"/>
    <param name="outputCoverageFile"/>
    <param name="outputIntensityFile"/>
    <param name="isChipSeq"/>
    <param name="computePeaks"/>
    <param name="readType"/>
    <param name="rnaSeqExtDbRlsSpec"/>
    <param name="genomeExtDbSpec"/>
    <param name="readLength"/>
    <param name="maxIntronSize"/>
    <param name="genomicSeqsFileForSsa"/>

    <constant name="dataDir">$$parentDataDir$$/analyze$$sampleName$$</constant>
    <constant name="uniqueFile">$$dataDir$$/uniqueMappings</constant>
    <constant name="nonUniqueFile">$$dataDir$$/nonUniqueMappings</constant>

    <step name="makeDataDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="mirrorToCluster" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <subgraph name="alignReadsToGenome"  xmlFile="ssa.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="bowtieGenomicIndexDir">$$bowtieGenomicIndexDir$$</paramValue>
      <paramValue name="bowtieTranscriptIndexDir">$$bowtieTranscriptIndexDir$$</paramValue>
      <paramValue name="geneModelFile">$$ssaGeneModelFile$$</paramValue>
      <paramValue name="useTranscripts">true</paramValue>
      <paramValue name="shortSeqsFile">$$shortSeqsFile$$</paramValue>
      <paramValue name="genomicSeqsFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="genomicSeqsDir">$$genomicSeqsDir$$</paramValue>
      <paramValue name="outputUniqueFile">$$uniqueFile$$</paramValue>
      <paramValue name="outputNonUniqueFile">$$nonUniqueFile$$</paramValue>
      <paramValue name="isChipSeq">$$isChipSeq$$</paramValue>
      <paramValue name="readType">$$readType$$</paramValue>
      <paramValue name="readLength">$$readLength$$</paramValue>
      <paramValue name="maxIntronSize">$$maxIntronSize$$</paramValue>
      <paramValue name="genomicSeqsFileForSsa">$$genomicSeqsFileForSsa$$</paramValue>
      <depends name="mirrorToCluster"/>
    </subgraph>

    <step name="makeUniqueNormalizedCoverageFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::SsaMakeNormalizedCoverageFile">
      <paramValue name="inputFile">$$uniqueFile$$</paramValue>
      <paramValue name="outputFile">$$outputCoverageFile$$.unique</paramValue>
      <paramValue name="sampleName">$$sampleName$$</paramValue>
      <depends name="alignReadsToGenome"/>
    </step>

    <step name="reformatUniqueCoverageFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ReformatCoverageFileForInsertNextGenSeqCoverageWithSqlLdr">
      <paramValue name="inputFile">$$outputCoverageFile$$.unique</paramValue>
      <paramValue name="outputFile">$$outputCoverageFile$$.unique.reformated</paramValue>
      <paramValue name="extDbRlsSpec">$$rnaSeqExtDbRlsSpec$$</paramValue>
      <paramValue name="genomeExtDbSpec">$$genomeExtDbSpec$$</paramValue>
      <paramValue name="sampleName">$$sampleName$$</paramValue>
      <paramValue name="multiple">false</paramValue>
      <depends name="makeUniqueNormalizedCoverageFile"/>
    </step>

    <step name="loadUniqueRnaSeqCoverage" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertNextGenSeqCoverageWithSqlLdr" stepLoadTypes="plugin">
      <paramValue name="inputFile">$$outputCoverageFile$$.unique.reformated</paramValue>
      <depends name="reformatUniqueCoverageFile"/>
    </step>

    <step name="makeNonUniqueNormalizedCoverageFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::SsaMakeNormalizedCoverageFile">
      <paramValue name="inputFile">$$nonUniqueFile$$</paramValue>
      <paramValue name="outputFile">$$outputCoverageFile$$.nonunique</paramValue>
      <paramValue name="sampleName">$$sampleName$$</paramValue>
      <depends name="alignReadsToGenome"/>
    </step>

    <step name="reformatNonUniqueCoverageFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ReformatCoverageFileForInsertNextGenSeqCoverageWithSqlLdr">
      <paramValue name="inputFile">$$outputCoverageFile$$.nonunique</paramValue>
      <paramValue name="outputFile">$$outputCoverageFile$$.nonunique.reformated</paramValue>
      <paramValue name="extDbRlsSpec">$$rnaSeqExtDbRlsSpec$$</paramValue>
      <paramValue name="genomeExtDbSpec">$$genomeExtDbSpec$$</paramValue>
      <paramValue name="sampleName">$$sampleName$$</paramValue>
      <paramValue name="multiple">true</paramValue>
      <depends name="makeNonUniqueNormalizedCoverageFile"/>
    </step>

    <step name="loadNonUniqueRnaSeqCoverage" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertNextGenSeqCoverageWithSqlLdr" stepLoadTypes="plugin">
      <paramValue name="inputFile">$$outputCoverageFile$$.nonunique.reformated</paramValue>
      <depends name="reformatNonUniqueCoverageFile"/>
    </step>

    <step name="makeIntensityFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::SsaMakeIntensityFile" excludeIf="$$isChipSeq$$">
      <paramValue name="inputCoverageFile">$$outputCoverageFile$$.unique</paramValue>
      <paramValue name="inputGeneModelFile">$$ssaGeneModelFile$$</paramValue>
      <paramValue name="outputIntensityFile">$$outputIntensityFile$$</paramValue>
      <depends name="makeUniqueNormalizedCoverageFile"/>
    </step>

</workflowGraph>
