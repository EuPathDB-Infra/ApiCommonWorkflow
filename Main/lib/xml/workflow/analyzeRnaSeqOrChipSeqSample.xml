<workflowGraph name="">
    <param name="parentDataDir"/>
    <param name="outputDir"/>
    <param name="sampleName"/>
    <param name="geneModelFileForSsa"/>
    <param name="experimentExtDbRlsSpec"/>
    <param name="genomeExtDbSpec"/>
    <param name="genomicSeqsFileForSsa"/>
    <param name="transcriptSeqsFileForSsa"/>
    <param name="hasPairedEnds"/>
    <param name="numInsertions"/>
    <param name="limitNU"/>
    <param name="strandSpecific"/>
    <param name="variableLengthReads"/>
    <param name="isRnaSeq"/>
     <param name="topLevelSeqSizeFile"/>

    <constant name="dataDir">$$parentDataDir$$/analyze_$$sampleName$$</constant>

    <step name="makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeDataDir"/>
    </step>
 
    <subgraph name="runRUMOnCluster"  xmlFile="runRUMOnCluster.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="readFilePath">$$shortSeqsFile$$</paramValue>
      <paramValue name="genomeFastaFile">$$genomicSeqsFileForSsa$$</paramValue>
      <paramValue name="geneAnnotationFile">$$geneModelFileForSsa$$</paramValue>
      <paramValue name="transcriptFastaFile">$$transcriptSeqsFileForSsa$$</paramValue>
      <paramValue name="hasPairedEnds">$$hasPairedEnds$$</paramValue>
      <paramValue name="limitNU">$$limitNU$$</paramValue>
      <paramValue name="numInsertions">$$numInsertions$$</paramValue>
      <paramValue name="createSAMFile">true</paramValue>
      <paramValue name="countMismatches">false</paramValue>
      <paramValue name="isSNPs">false</paramValue>
      <paramValue name="strandSpecific">$$strandSpecific$$</paramValue>
      <paramValue name="createJunctionsFile">true</paramValue>
      <paramValue name="variableLengthReads">$$variableLengthReads$$</paramValue>
      <paramValue name="topLevelSeqSizeFile">$$topLevelSeqSizeFile$$</paramValue>
      <paramValue name="createBigWigFile">true</paramValue>
      <depends name="mirrorToCluster"/>
    </subgraph>

    <step name="document-RnaSeqOrChipSeqRum"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertAnalysisMethodInvocation">
      <paramValue name="method">rum_rna_or_chip_seq_MTHD</paramValue>
      <paramValue name="version">1.0</paramValue>
      <paramValue name="parameters"></paramValue>
      <depends name="runRUMOnCluster"/>
    </step>


    <step name="loadExonJunctionCall" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertRUMIntronFeature" stepLoadTypes="plugin" includeIf="$$isRnaSeq$$">
      <paramValue name="inputFile">$$dataDir$$/master/mainresult/junctions_all.rum</paramValue>
      <paramValue name="rnaSeqExtDbRlsSpec">$$experimentExtDbRlsSpec$$</paramValue>
      <paramValue name="sampleName">$$sampleName$$</paramValue>
      <depends name="runRUMOnCluster"/>
    </step>


<!-- outputs basename.min and basename.max -->
    <step name="makeIntensityFiles" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::SsaMakeIntensityFile" includeIf="$$isRnaSeq$$">
      <paramValue name="inputSortedFile">$$dataDir$$/master/mainresult/RUM_Unique.sorted,$$dataDir$$/master/mainresult/RUM_NU.sorted</paramValue>
      <paramValue name="inputGeneModelFile">$$geneModelFileForSsa$$</paramValue>
      <paramValue name="outputIntensityFileBasename">$$outputDir$$/$$sampleName$$.intensity</paramValue>
      <paramValue name="strand"></paramValue>
      <paramValue name="antisense">false</paramValue>
      <depends name="runRUMOnCluster"/>
    </step>

    <step name="generateMappingStatsFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::GenerateMappingStatsFile">
      <paramValue name="uniqueFile">$$dataDir$$/master/mainresult/RUM_Unique.sorted</paramValue>
      <paramValue name="nonUniqueFile">$$dataDir$$/master/mainresult/RUM_NU.sorted</paramValue>
      <paramValue name="outputFile">$$outputDir$$/$$sampleName$$.mappingStats</paramValue>
      <depends name="runRUMOnCluster"/>
    </step>

    <step name="generateCountFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::GenerateCountFile">
      <paramValue name="uniqueFile">$$dataDir$$/master/mainresult/RUM_Unique.sorted</paramValue>
      <paramValue name="nonUniqueFile">$$dataDir$$/master/mainresult/RUM_NU.sorted</paramValue>
      <paramValue name="geneAnnotationFile">$$geneModelFileForSsa$$</paramValue>
      <paramValue name="outputFile">$$outputDir$$/$$sampleName$$.count</paramValue>
      <paramValue name="strand"></paramValue>
      <depends name="runRUMOnCluster"/>
    </step>


    <!-- am I allowed to have an includeIf in the subgraphCall?? -->
    <subgraph name="makeRUMIntensityFiles"  xmlFile="makeRUMIntensityFiles.xml" includeIf="$$isRnaSeq$$">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="inputGeneModelFile">$$geneModelFileForSsa$$</paramValue>
      <paramValue name="outputDir">$$outputDir$$</paramValue>
      <paramValue name="sampleName">$$sampleName$$</paramValue>
      <paramValue name="isStrandSpecific">$$strandSpecific$$</paramValue>
      <depends name="runRUMOnCluster"/>
    </subgraph>



</workflowGraph>


