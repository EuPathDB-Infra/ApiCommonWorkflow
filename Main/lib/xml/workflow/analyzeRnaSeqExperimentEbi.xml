<orkflowGraph name="">
    <param name="projectName"/>
    <param name="organismAbbrev"/>
    <param name="organismDatasetLoaderXmlFile"/>
    <param name="experimentName"/>
    <param name="parentDataDir"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="experimentDatasetName"/>
    <param name="experimentDatasetVersion"/>
    <param name="strandSpecific"/>
    <param name="topLevelSeqSizeFile"/>
    <param name="topLevelFastaFile"/>
    <param name="topLevelGeneFootprintFile"/>
    <param name="relativeDownloadSiteDir"/>
    <param name="relativeWebServicesDir"/>
    <param name="ebiOrganismName"/>
    <param name="ebiVersion"/>

    <constant name="dataDir">$$parentDataDir$$/$$experimentName$$</constant>
    <constant name="samplesOutputDir">$$dataDir$$/samples</constant>
    <constant name="doTranscriptExpression">$$asmplesOutputDir$$/doTranscriptExpression</constant>

    <!-- this will make the dataDir as defined by the constant above-->
    <subgraph name="loadDataset" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">$$experimentDatasetName$$</paramValue>
      <paramValue name="datasetLoaderXmlFileName">$$organismDatasetLoaderXmlFile$$</paramValue>
      <paramValue name="parentDataDir">$$parentDataDir$$</paramValue>
    </subgraph>

    <constant name="analysisConfig">$$dataDir$$/final/$$experimentName$$.xml</constant>

    <!-- we will download the sample directories here -->
    <step name="makeSamplesOutputDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$samplesOutputDir$$</paramValue>
      <depends name="loadDataset"/>
    </step>

    <!-- analysis here -->
    <step name="makeDoTranscriptExpressionDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$doTranscriptExpression$$</paramValue>
      <depends name="loadDataset"/>
    </step>

    <!--download from EBI ftp-->
    <step name="fetchEbiRNASeq" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::FetchEbiRNASeq">
      <paramValue name="ebiVersion">$$ebiVersion$$</paramValue>
      <paramValue name="ebiOrganismName">$$ebiOrganismName$$</paramValue>
      <paramValue name="experimentName">$$experimentName$$</paramValue>
      <paramValue name="samplesDir">$$samplesOutputDir$$</paramValue>
      <depends name="makeSamplesOutputDir"/>
    </step>

    <!-- for junctions and bed files, prepend the organismAbbrev to a fixed version of the file-->
    <step name="fixSeqIdEbiRNASeq" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::FixSeqIdEbiRNASeq">
      <paramValue name="samplesDir">$$samplesOutputDir$$</paramValue>
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <depends name="fetchEbiRNASeq"/>
    </step>

    <step name="tpmFromHtseqCounts" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::TpmFromHtseqCounts">
      <paramValue name="samplesDir">$$samplesOutputDir$$</paramValue>
      <paramValue name="geneFootprintFile">$$topLevelGeneFootprintFile$$</paramValue>
      <paramValue name="strandSpecific">$$strandSpecific</paramValue>
      <paramValue name="analysisConfig">$$analysisConfig$$</paramValue>
      <depends name="fixSeqIdEbiRNASeq"/>
    </step>

    <step name="doTranscriptExpression" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::DoTranscriptExpressionEbi">
      <paramValue name="analysisConfigFile">$$analysisConfig$$</paramValue>
      <paramValue name="inputDir">$$samplesOutputDir$$</paramValue>
      <paramValue name="outputDir">$$doTranscriptExpression$$</paramValue>
      <paramValue name="technologyType">RNASeq</paramValue>
      <!-- If subclass of DoTranscriptExpression... will need these. otherwise leave out
      <paramValue name="geneProbeMappingTabFile"></paramValue>
      <paramValue name="geneProbeMappingVendorFile"></paramValue>
      <paramValue name="platformDirectory"></paramValue>
      <paramValue name="expectCdfFile">false</paramValue>
      <paramValue name="expectNdfFile">false</paramValue>
      <paramValue name="passPlatformMappingFile">true</paramValue>
      -->
      <depends name="tpmFromHtseqCounts"/>
      <depends name="makeDoTranscriptExpressionDir"/>
    </step>

    <step name="loadStudyResultsFromConfig" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyResults" stepLoadTypes="plugin">
      <paramValue name="configFile">$$doTranscriptExpression$$/insert_study_results_config.txt</paramValue>
      <paramValue name="inputDir">$$doTranscriptExpression$$</paramValue>
      <paramValue name="extDbRlsSpec">$$experimentDatasetName$$|$$experimentDatasetVersion$$</paramValue>
      <paramValue name="studyName">$$experimentDatasetName$$</paramValue>
      <depends name="doTranscriptExpression"/>
      <dependsGlobal name="oboOntologies"/>
    </step>

    <!-- TODO: sample directory paths need to be updated here -->
    <step name="loadRNASeqMetrics" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertRNASeqMetrics" stepLoadTypes="plugin">
      <paramValue name="experimentDir">$$samplesOutputDir$$</paramValue>
      <paramValue name="extDbRlsSpec">$$experimentDatasetName$$|$$experimentDatasetVersion$$</paramValue>
      <depends name="loadStudyResultsFromConfig"/>
      <dependsGlobal name="oboOntologies"/>
      <dependsGlobal name="eupathCuratedOntologies"/>
    </step>


    <step name="normalizeCoverage" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::NormalizeBedGraphiEbi">
      <paramValue name="inputDir">$$samplesOutputDir$$</paramValue> <!-- TODO:  check this -->
      <paramValue name="topLevelSeqSizeFile">$$topLevelSeqSizeFile$$</paramValue>
      <paramValue name="analysisConfig">$$analysisConfig$$</paramValue>
      <depends name="fixSeqIdEbiRNASeq"/>
    </step>

    <!-- TODO:  Pretty sure we'll need another step here because of different directory structure
    <step name="copyNormalizedBedGraphToWebServiceDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyNormalizedBedGraphToWebServiceDir">
      <paramValue name="copyFromDir">TODO</paramValue>
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
      <paramValue name="experimentDatasetName">$$experimentDatasetName$$</paramValue>
      <depends name="doTranscriptExpression"/>
      <depends name="normalizeCoverage"/>
    </step>
     -->

</workflowGraph>


