<workflowGraph name="loadGenome">
      <param name="parentDataDir"/>
      <param name="organismName"/>
      <param name="genomeExtDbRlsSpec"/>
      <param name="organismResourceXmlFile"/>
      <param name="organismSpecificISFReference"/>
      <param name="ncbiTaxonId"/>
      <param name="downloadSiteDataDir"/>
      <param name="extractProteins"/>
      <param name="projectName"/>

    <constant name="dataDir">$$parentDataDir$$/$$organismName$$LoadGenome</constant>
    <constant name="genomicSeqsFileForSsa">$$dataDir$$/genomicSeqsForSsa.fsa</constant>
    <constant name="transcriptSeqsFileForSsa">$$dataDir$$/transcriptSeqsForSsa.fsa</constant>
    <constant name="geneModelFileForSsa">$$dataDir$$/geneModelForSsa.txt</constant>
    <constant name="genomicSeqsFile">$$dataDir$$/genomicSeqs.fsa</constant>
    <constant name="genomicSeqsDir">$$dataDir$$/genomicSeqs</constant>
    <constant name="proteinsFile">$$dataDir$$/AnnotatedProteins.fsa</constant>
    <constant name="bowtieGenomicIndexDir">$$dataDir$$/genomicIndexes</constant>
    <constant name="bowtieTranscriptIndexDir">$$dataDir$$/transcriptsIndexes</constant>

    <step name="makeDataDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeDownloadSiteDataDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeApiSiteFilesDir">
      <paramValue name="apiSiteFilesDir">$$downloadSiteDataDir$$/$$organismName$$</paramValue>
    </step>

  <step name="insertOrganismProject"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertOrganismProject">
      <paramValue name="organism">$$organismName$$</paramValue>
      <paramValue name="project">$$projectName$$</paramValue>
    </step>

  <subgraph name="organismSpecificISF" xmlFile="$$organismSpecificISFReference$$">
    <paramValue name="organismResourceXmlFile">$$organismResourceXmlFile$$</paramValue>
    <paramValue name="dataDir">$$dataDir$$</paramValue>
    <depends name="makeDataDir"/>
  </subgraph>

  <step name="extractGenomicSeqs"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractNaSeqs">
      <paramValue name="extDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="alternateDefline"></paramValue>
      <paramValue name="outputFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="separateFastaFiles">false</paramValue>
      <paramValue name="outputDirForSeparateFiles"></paramValue>
      <depends name="organismSpecificISF"/> 
    </step>

    <step name="extractProteins"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractAnnotatedProteinsBySpecies" includeIf="$$extractProteins$$">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="outputFile">$$proteinsFile$$</paramValue>
      <depends name="organismSpecificISF"/>
    </step>

    <step name="extractGenomicSeqsIntoSeparateFastaFiles"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractNaSeqs">
      <paramValue name="extDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="outputFile"></paramValue>
      <paramValue name="alternateDefline"></paramValue>
      <paramValue name="separateFastaFiles">true</paramValue>
      <paramValue name="outputDirForSeparateFiles">$$genomicSeqsDir$$_ori</paramValue>
      <depends name="organismSpecificISF"/>
    </step>

    <step name="makeGenomeTargetListFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeGenomeTargetListFile">
      <paramValue name="targetDir">$$genomicSeqsDir$$</paramValue>
      <paramValue name="outputFile">$$dataDir$$/targetList</paramValue>
      <depends name="extractGenomicSeqsIntoSeparateFastaFiles"/>
    </step>

    <step name="mirrorToCluster" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="extractGenomicSeqs"/>
      <depends name="extractProteins"/>
      <depends name="makeGenomeTargetListFile"/>
      <dependsGlobal name="initClusterHomeDir"/>
    </step>

    <step name="runNibOnCluster" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RunNibOnCluster">
      <paramValue name="inputFile">$$dataDir$$/targetList</paramValue>
      <paramValue name="outputDir">$$genomicSeqsDir$$</paramValue>
      <depends name="mirrorToCluster"/>
    </step>

  <step name="extractGenomicSeqsForSsa"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractNaSeqsForSsa">
      <paramValue name="extDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="outputFile">$$genomicSeqsFileForSsa$$</paramValue>
      <depends name="organismSpecificISF"/> 
    </step>


  <step name="indexGenomicSeqsForBowtie"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CreateBowtieIndexes">
      <paramValue name="inputFile">$$genomicSeqsFileForSsa$$</paramValue>
      <paramValue name="outputIndexDir">$$bowtieGenomicIndexDir$$</paramValue>
      <depends name="extractGenomicSeqsForSsa"/> 
    </step>

  <step name="extractTranscriptSeqsForSsa"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractTranscriptSeqsForSsa" includeIf="$$extractProteins$$">
      <paramValue name="extDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="outputFile">$$transcriptSeqsFileForSsa$$</paramValue>
      <depends name="organismSpecificISF"/> 
    </step>

  <step name="indexTranscriptsSeqsForBowtie"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CreateBowtieIndexes" includeIf="$$extractProteins$$">
      <paramValue name="inputFile">$$transcriptSeqsFileForSsa$$</paramValue>
      <paramValue name="outputIndexDir">$$bowtieTranscriptIndexDir$$</paramValue>
      <depends name="extractTranscriptSeqsForSsa"/> 
    </step>

  <step name="extractGeneModelForSsa"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractGeneModelForSsa" includeIf="$$extractProteins$$">
      <paramValue name="ncbiTaxonId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="outputFile">$$geneModelFileForSsa$$</paramValue>
      <depends name="organismSpecificISF"/> 
    </step>

</workflowGraph>
