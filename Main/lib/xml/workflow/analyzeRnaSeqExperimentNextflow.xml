<workflowGraph name="">
    <param name="projectName"/>
    <param name="organismAbbrev"/>
    <param name="organismDatasetLoaderXmlFile"/>
    <param name="experimentName"/>
    <param name="parentDataDir"/>
    <param name="experimentDatasetName"/>
    <param name="experimentDatasetVersion"/>
    <param name="isPairedEnd"/>
    <param name="strandSpecific"/>
    <param name="isCDS"/>
    <param name="topLevelSeqSizeFile"/>
    <param name="topLevelGeneFootprintFile"/>
    <param name="gtfFile"/>
    <param name="isSRA"/>
    <param name="relativeWebServicesDir"/>
    <param name="hisatIndex"/>
    <!--<param name="ebiOrganismName"/>-->
    <!--<param name="ebiVersion"/>-->

    <constant name="dataDir">$$parentDataDir$$/$$experimentName$$</constant>
    <constant name="analysisConfig">$$parentDataDir$$/$$experimentDatasetName$$/final/analysisConfig.xml</constant>

    <subgraph name="loadDataset" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">$$experimentDatasetName$$</paramValue>
      <paramValue name="datasetLoaderXmlFileName">$$organismDatasetLoaderXmlFile$$</paramValue>
      <paramValue name="parentDataDir">$$parentDataDir$$</paramValue>
    </subgraph>


    <step name="makeSamplesOutputDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
      <depends name="loadDataset"/>
    </step>
<!-- Previous code to fetch results from the Ebi
    <step name="fetchEbiRNASeq" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::FetchEbiRNASeq">
      <paramValue name="ebiVersion">$$ebiVersion$$</paramValue>
      <paramValue name="ebiOrganismName">$$ebiOrganismName$$</paramValue>
      <paramValue name="experimentName">$$experimentName$$</paramValue>
      <paramValue name="samplesDir">$$parentDataDir$$</paramValue>
      <paramValue name="projectName">$$projectName$$</paramValue>
      <depends name="makeSamplesOutputDir"/>
    </step>
-->  
    <!-- New step to generate the nextflow Config file for the analysis -->
    <step name="makeBulkRnaSeqNextflowConfig" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeBulkRnaSeqNextflowConfig">
      <paramValue name="inputDir">$$dataDir$$</paramValue>
      <paramValue name="analysisDir">$$parentDataDir$$</paramValue>
      <paramValue name="dataSource">$$parentDataDir$$/$$experimentDatasetName$$/final</paramValue>
      <paramValue name="clusterResultDir">$$parentDataDir$$/$$experimentName$$</paramValue>
      <paramValue name="annotation">$$parentDataDir$$/$$gtfFile$$</paramValue>
      <paramValue name="hisat2Index">$$parentDataDir$$</paramValue>
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="isSRA">$$isSRA$$</paramValue>
      <paramValue name="isPaired">$$isPairedEnd$$</paramValue>
      <paramValue name="isStrandSpecific">$$strandSpecific$$</paramValue>
      <paramValue name="isCDS">$$isCDS$$</paramValue>
      <paramValue name="configFileName">$$parentDataDir$$/$$experimentName$$/nextflow.config</paramValue>
      <depends name="makeSamplesOutputDir"/>
    </step>

    <!-- for junctions and bed files -->
   <!-- Previous Ebi step for junctions and bed
     <step name="fixSeqIdEbiRNASeq" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::FixSeqIdEbiRNASeq">
      <paramValue name="samplesDir">$$dataDir$$</paramValue>
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <depends name="fetchEbiRNASeq"/>
    </step>
   -->

    <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeBulkRnaSeqNextflowConfig"/>
    </step>

    <step name="runBulkRnaSeqExperiment" stepClass="ReFlow::StepClasses::RunAndMonitorNextflow">
      <paramValue name="workingDir">$$dataDir$$</paramValue>
      <paramValue name="resultsDir">$$dataDir$$</paramValue>
      <paramValue name="nextflowConfigFile">$$dataDir$$/nextflow.config</paramValue>
      <paramValue name="nextflowWorkflow">VEuPathDB/bulkRnaSeq</paramValue>
      <paramValue name="isGitRepo">true</paramValue>
      <paramValue name="revision">main</paramValue>
      <depends name="mirrorToCluster"/>
    </step>

    <step name="tpmFromHtseqCounts" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::TpmFromHtseqCounts">
      <paramValue name="samplesDir">$$dataDir$$</paramValue>
      <paramValue name="geneFootprintFile">$$topLevelGeneFootprintFile$$</paramValue>
      <paramValue name="strandSpecific">$$strandSpecific$$</paramValue>
      <paramValue name="analysisConfig">$$analysisConfig$$</paramValue>
      <depends name="runBulkRnaSeqExperiment"/>
    </step>

    <step name="doTranscriptExpression" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::DoTranscriptExpressionEbi">
      <paramValue name="analysisConfigFile">$$analysisConfig$$</paramValue>
      <paramValue name="outputDir">$$dataDir$$</paramValue>
      <paramValue name="technologyType">RNASeqEbi</paramValue>
      <depends name="tpmFromHtseqCounts"/>
    </step>

    <step name="loadStudyResultsFromConfig" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyResults" stepLoadTypes="plugin">
      <paramValue name="configFile">$$dataDir$$/insert_study_results_config.txt</paramValue>
      <paramValue name="inputDir">$$dataDir$$</paramValue>
      <paramValue name="extDbRlsSpec">$$experimentDatasetName$$|$$experimentDatasetVersion$$</paramValue>
      <paramValue name="studyName">$$experimentDatasetName$$</paramValue>
      <depends name="doTranscriptExpression"/>
      <!--<dependsGlobal name="oboOntologies"/>-->
    </step>

    <step name="loadRNASeqMetrics" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertRNASeqMetrics" stepLoadTypes="plugin">
      <paramValue name="experimentDir">$$dataDir$$</paramValue>
      <paramValue name="extDbRlsSpec">$$experimentDatasetName$$|$$experimentDatasetVersion$$</paramValue>
      <depends name="loadStudyResultsFromConfig"/>
      <!--<dependsGlobal name="oboOntologies"/> -->
      <!--<dependsGlobal name="eupathCuratedOntologies"/> -->
    </step>


    <step name="normalizeCoverage" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::NormalizeBedGraphEbi">
      <paramValue name="inputDir">$$dataDir$$</paramValue>
      <paramValue name="topLevelSeqSizeFile">$$topLevelSeqSizeFile$$</paramValue>
      <paramValue name="analysisConfig">$$analysisConfig$$</paramValue>
      <depends name="runBulkRnaSeqExperiment"/>
    </step>

    <step name="copyNormalizedBedGraphToWebServiceDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyNormalizedBedGraphToWebServiceDir">
      <paramValue name="copyFromDir">$$dataDir$$</paramValue>
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
      <paramValue name="experimentDatasetName">$$experimentDatasetName$$</paramValue>
      <depends name="doTranscriptExpression"/>
      <depends name="normalizeCoverage"/>
    </step>
    
    <step name="makeMergedBigwigs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RNAseqMerge">
        <paramValue name="inputsDir">$$dataDir$$</paramValue>
        <paramValue name="experimentName">$$experimentName$$</paramValue>
        <paramValue name="chromSizesFile">$$topLevelSeqSizeFile$$</paramValue>
        <paramValue name="analysisConfig">$$analysisConfig$$</paramValue>
        <depends name="normalizeCoverage"/>
    </step>

    <step name="copyMergedBigwigsToWebSvc" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyRnaSeqMergedBigwigsToWebSvc">
        <paramValue name="copyFromDir">$$dataDir$$/mergedBigwigs</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
        <paramValue name="experimentDatasetName">$$experimentDatasetName$$</paramValue>
        <depends name="makeMergedBigwigs"/>
        <depends name="copyNormalizedBedGraphToWebServiceDir"/>
    </step>
</workflowGraph>


