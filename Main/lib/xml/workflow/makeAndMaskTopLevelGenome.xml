<workflowGraph name="makeAndMaskTopLevelGenome">
      <param name="dataDir"/>
      <param name="organismAbbrev"/>
      <param name="projectName"/>
      <param name="organismResourceXmlFile"/>
      <param name="comparativeGenomicsDir"/>
      <param name="isAnnotatedGenome"/>
      <param name="strainsComparisonInputDir"/>
      <param name="genomicSeqsFileForSsa"/>
      <param name="transcriptSeqsFileForSsa"/>
      <param name="geneModelFileForSsa"/>
      <param name="cdsModelFileForSsa"/>


    <constant name="topLevelFastaFile">$$dataDir$$/topLevelGenomicSeqs.fsa</constant>

    <step name="makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

  <!-- optional dataset.  the subgraph might be empty -->
  <subgraph name="insertPrimaryVirtualGenome" xmlFile="generated/$$projectName$$/$$organismAbbrev$$/primaryVirtualGenome.xml" excludeIfXmlFileDoesNotExist="true">
    <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
    <paramValue name="organismResourceXmlFile">$$organismResourceXmlFile$$</paramValue>
    <paramValue name="parentDataDir">$$dataDir$$</paramValue>
    <depends name="makeDataDir"/> 
  </subgraph>

  <!-- FeatureLocation, GeneAttributes and SequenceAttributes (for top level) -->
  <step name="makeDerivedTopLevelTables"
        stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDerivedTopLevelTables" stepLoadTypes="tuningManager">
    <depends name="insertPrimaryVirtualGenome"/> 
  </step>

  <!-- ApiDBTuning.SequenceAttributes -->
  <step name="extractTopLevelFastaSeqs"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractTopLevelFastaSeqs">
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="outputFile">$$topLevelFastaFile$$</paramValue>
      <depends name="makeDerivedTopLevelTables"/> 
    </step>

  <step name="extractGenomicSeqsForSsa"
        stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractNaSeqsForSsa">
    <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
    <paramValue name="outputFile">$$genomicSeqsFileForSsa$$</paramValue>
    <depends name="makeDerivedTopLevelTables"/>
  </step>

  <step name="extractTranscriptSeqsForSsa"
        stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractTranscriptSeqsForSsa" includeIf="$$isAnnotatedGenome$$">
    <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
    <paramValue name="outputFile">$$transcriptSeqsFileForSsa$$</paramValue>
    <depends name="makeDerivedTopLevelTables"/>
  </step>

  <step name="extractGeneModelForSsa"
        stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractGeneModelForSsa" includeIf="$$isAnnotatedGenome$$">
    <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
    <paramValue name="outputFile">$$geneModelFileForSsa$$</paramValue>
    <paramValue name="useCDSCoordinates">false</paramValue>
    <depends name="makeDerivedTopLevelTables"/>
  </step>

  <step name="extractCdsModelForSsa"
        stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractGeneModelForSsa" includeIf="$$isAnnotatedGenome$$">
    <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
    <paramValue name="outputFile">$$cdsModelFileForSsa$$</paramValue>
    <paramValue name="useCDSCoordinates">true</paramValue>
    <depends name="makeDerivedTopLevelTables"/>
  </step>

    <step name="makeClusterTaskInputDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeGenomeRepeatMaskTaskInputDir" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="seqsFile">$$topLevelFastaFile$$</paramValue>
      <paramValue name="dangleMax">0</paramValue>
      <paramValue name="trimDangling">n</paramValue>
      <paramValue name="options">-xsmall</paramValue>
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <depends name="extractTopLevelFastaSeqs"/>
    </step>

    <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="extractGenomicSeqsForSsa"/>
      <depends name="extractTranscriptSeqsForSsa"/>
      <depends name="extractGeneModelForSsa"/>
      <depends name="extractCdsModelForSsa"/>
      <depends name="makeClusterTaskInputDir"/>
    </step>

    <step name="runClusterTask" stepClass="ReFlow::StepClasses::RunAndMonitorDistribJob" stepLoadTypes="cluster" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="numNodes">10</paramValue>
      <paramValue name="processorsPerNode">1</paramValue>
      <depends name="mirrorToCluster"/>
    </step>

    <step name="mirrorFromCluster" stepClass="ReFlow::StepClasses::MirrorFromComputeCluster" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/master</paramValue>
      <paramValue name="outputDir">$$dataDir$$/master/mainresult</paramValue>
      <paramValue name="outputFiles">blocked.err,blocked.seq</paramValue>
      <depends name="runClusterTask"/>
    </step>

    <step name="copyMaskedTopLevelFastaFileToComparativeGenomicsDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDataDirFile" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="fromFile">$$dataDir$$/master/mainresult/blocked.seq</paramValue>
      <paramValue name="toFile">$$comparativeGenomicsDir$$/$$organismAbbrev$$.fasta</paramValue>
      <depends name="mirrorFromCluster"/>
    </step>

    <step name="copyMaskedTopLevelFastaFileToStrainsComparisonDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDataDirFile" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="fromFile">$$dataDir$$/master/mainresult/blocked.seq</paramValue>
      <paramValue name="toFile">$$strainsComparisonInputDir$$/$$organismAbbrev$$.fasta</paramValue>
      <depends name="mirrorFromCluster"/>
    </step>

  <!-- ApiDB.FeatureLocation -->
  <step name="makeMercatorGffFile"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeMercatorGffFile" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="outputFile">$$dataDir$$/$$organismAbbrev$$.gff</paramValue>
       <depends name="makeDerivedTopLevelTables"/> 
    </step>

  <step name="correctReadingFrameInMercatorGffFile"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CorrectReadingFrameInMercatorGffFile" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="inputFastaFile">$$topLevelFastaFile$$</paramValue>
      <paramValue name="inputGffFile">$$dataDir$$/$$organismAbbrev$$.gff</paramValue>
      <paramValue name="outputGffFile">$$dataDir$$/$$organismAbbrev$$_corrected.gff</paramValue>
      <depends name="makeMercatorGffFile"/> 
    </step>

  <step name="copyCorrectedGffFileToComparativeGenomicsDir"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDataDirFile" includeIf="$$isAnnotatedGenome$$">
      <paramValue name="fromFile">$$dataDir$$/$$organismAbbrev$$_corrected.gff</paramValue>
      <paramValue name="toFile">$$comparativeGenomicsDir$$/$$organismAbbrev$$.gff</paramValue>
      <depends name="correctReadingFrameInMercatorGffFile"/> 
    </step>

  <step name="copyCorrectedGffFileToStrainsComparisonDir"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDataDirFile"  includeIf="$$isAnnotatedGenome$$">
      <paramValue name="fromFile">$$dataDir$$/$$organismAbbrev$$_corrected.gff</paramValue>
      <paramValue name="toFile">$$strainsComparisonInputDir$$/$$organismAbbrev$$.gff</paramValue>
      <depends name="correctReadingFrameInMercatorGffFile"/> 
    </step>
</workflowGraph>
