<workflowGraph name="makeAndMaskTopLevelGenome">
      <param name="parentDataDir"/>
      <param name="organismAbbrev"/>
      <param name="organismFullName"/>
      <param name="genomeExtDbRlsSpec"/>
      <param name="genomeVirtualSeqsExtDbRlsSpec"/>
      <param name="insertVirtualSeqFromAgpFile"/>
      <param name="runComparativeGenomics"/>
      <param name="repeatMaskSpeciesOption"/>
      <param name="organismResourceXmlFile"/>
      <param name="comparativeGenomicsFastaDir"/>
      <param name="comparativeGenomicsGffDir"/>

    <constant name="dataDir">$$parentDataDir$$/$$organismAbbrev$$_MakeAndMaskTopLevelGenome</constant>
    <constant name="topLevelFastaFile">$$dataDir$$/topLevelGenomicSeqs.fsa</constant>

    <step name="makeDataDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

  <subgraph name="insertVirtualSeqFromAgpFile" xmlFile="loadResource.xml" includeIf="$$insertVirtualSeqFromAgpFile$$">
    <paramValue name="resourceName">genome_virtual_sequence_agp_RSRC</paramValue>
    <paramValue name="resourceXmlFileName">$$organismResourceXmlFile$$</paramValue>
    <paramValue name="parentDataDir">$$dataDir$$</paramValue>
    <depends name="makeDataDir"/> 
  </subgraph>

  <step name="runTuningManager"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RunTuningManager" includeIf="$$insertVirtualSeqFromAgpFile$$">
      <depends name="insertVirtualSeqFromAgpFile"/> 
  </step>

  <step name="extractTopLevelFastaSeqs"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExtractTopLevelFastaSeqs">
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="genomeVirtualSeqsExtDbRlsSpec">$$genomeVirtualSeqsExtDbRlsSpec$$</paramValue>
      <paramValue name="outputFile">$$topLevelFastaFile$$</paramValue>
      <depends name="runTuningManager"/> 
    </step>

    <step name="makeClusterTaskInputDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeSoftMaskTaskInputDir" includeIf="$$runComparativeGenomics$$">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="seqsFile">$$topLevelFastaFile$$</paramValue>
      <paramValue name="options">$$repeatMaskSpeciesOption$$ -xsmall</paramValue>
      <depends name="extractTopLevelFastaSeqs"/>
    </step>

    <step name="mirrorToCluster" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MirrorToComputeCluster" includeIf="$$runComparativeGenomics$$">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeClusterTaskInputDir"/>
    </step>

    <step name="runClusterTask" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RunAndMonitorClusterTask" stepLoadTypes="cluster" includeIf="$$runComparativeGenomics$$">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="numNodes">20</paramValue>
      <paramValue name="processorsPerNode">2</paramValue>
      <depends name="mirrorToCluster"/>
    </step>

    <step name="mirrorFromCluster" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MirrorFromComputeCluster" includeIf="$$runComparativeGenomics$$">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/master</paramValue>
      <paramValue name="outputDir">$$dataDir$$/master/mainresult</paramValue>
      <paramValue name="outputFiles">blocked.err,blocked.seq</paramValue>
      <depends name="runClusterTask"/>
    </step>

    <step name="copyMaskedTopLevelFastaFileToComparativeGenomicsFastaDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDataDirFile" includeIf="$$runComparativeGenomics$$">
      <paramValue name="fromFile">$$dataDir$$/master/mainresult/blocked.seq</paramValue>
      <paramValue name="toFile">$$comparativeGenomicsFastaDir$$/$$organismAbbrev$$.fasta</paramValue>
      <depends name="mirrorFromCluster"/>
    </step>

  <step name="makeMercatorGffFile"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeMercatorGffFile" includeIf="$$runComparativeGenomics$$">
      <paramValue name="organismFullName">$$organismFullName$$</paramValue>
      <paramValue name="outputFile">$$dataDir$$/$$organismAbbrev$$.gff</paramValue>
       <depends name="runTuningManager"/> 
    </step>

  <step name="correctReadingFrameInMercatorGffFile"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CorrectReadingFrameInMercatorGffFile" includeIf="$$runComparativeGenomics$$">
      <paramValue name="inputFastaFile">$$topLevelFastaFile$$</paramValue>
      <paramValue name="inputGffFile">$$dataDir$$/$$organismAbbrev$$.gff</paramValue>
      <paramValue name="outputGffFile">$$dataDir$$/$$organismAbbrev$$_corrected.gff</paramValue>
      <depends name="makeMercatorGffFile"/> 
    </step>

  <step name="copyCorrectedGffFileToComparativeGenomicsGffDir"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDataDirFile" includeIf="$$runComparativeGenomics$$">
      <paramValue name="fromFile">$$dataDir$$/$$organismAbbrev$$_corrected.gff</paramValue>
      <paramValue name="toFile">$$comparativeGenomicsGffDir$$/$$organismAbbrev$$.gff</paramValue>
      <depends name="correctReadingFrameInMercatorGffFile"/> 
    </step>
</workflowGraph>
