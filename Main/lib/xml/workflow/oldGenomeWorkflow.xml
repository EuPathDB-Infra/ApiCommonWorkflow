<workflowGraph name="genomeWorkflow">
  <param name="genomeName"/>
  <param name="genomeExtDb"/>
  <param name="genomeExtDbRls"/>
  <param name="interproVersion"/>
  <param name="soVersion"/>
  <param name="ncbiTaxonVersion"/>
  <param name="ncbiTaxonId"/>

  <constant name="Pf">Pfalciparum</constant>
  <constant name="Pb">Pberghei</constant>
  <constant name="Pv">Pvivax</constant>
  <constant name="Py">Pyoelii</constant>
  <constant name="genomeExtDbRlsSpec">$$genomeExtDb$$:$$genomeExtDbRls$$</constant>
  <constant name="soExtDbRlsSpec">SequenceOntology:$$soVersion$$</constant>
  <constant name="taxonomyExtDbRlsSpec">ncbiTaxon:$$ncbiTaxonVersion$$</constant>
  <constant name="nrdbFile">seqfiles/nr.fsa</constant>
  <constant name="nrdbExtDbRlsSpec">NRD|$nrdbVersion</constant>
  <constant name="nrdbShortDeflineFile">seqfiles/nrShortDefline.fsa</constant>
  <constant name="proteinsFile">seqfiles/$$genomeName$$AnnotatedProteins.fsa</constant>
  <constant name="genomicSeqsFile">seqfiles/$$genomeName$$GenomicSeqs.fsa</constant>

  <steps>
    <subflowStep name="NRDB" subflow="resource" global="true">
      <paramValue name="nrdbExtDbRlsSpec">$nrdbExtDbRlsSpec</paramValue>
      <paramValue name="nrdbOutputFile">$nrdbFile</paramValue>
      <paramValue name="nrdbShortDeflineOutputFile">$nrdbShortDeflineFile</paramValue>
      <paramValue name="extDbRlsSpec">$taxonmyExtDbRlsSpec</paramValue>
    </step>

    <subflowStep name="taxonomy" subflow="resource" global="true"/>
      <paramValue name="extDbRlsSpec">$taxonmyExtDbRlsSpec</paramValue>
    </step>

    <subflowStep name="SO" subflow="resource" global="true">
      <paramValue name="extDbRlsSpec">$soExtDbRlsSpec</paramValue>
    </step>

    <subflowStep name="genome" subflow="resource">
      <paramValue name="extDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
    </step>

    <step name="extractGenomicSeqs"
          stepClass="ApiCommonData::Load::WorkflowSteps::ExtractNaSeqs">
      <paramValue name="genomeName">$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <paramValue name="ncbiTaxId">$ncbiTaxonId</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="seqType">genomicSeqs</paramValue>
      <paramValue name="identifier">source_id</paramValue>
      <paramValue name="outputFile">$genomicSeqsFile</paramValue>
      <depends name="genome"/>
    </step>

    <step name="calcTranslatedProteins"
          stepClass="ApiCommonData::Load::WorkflowSteps::CalculateTranslatedProteinSequence">
      <include match="$genomeName" list="$Pf,$Pb,$Py,$Pv"/>
      <paramValue name="genomeExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <paramValue name="soExtDbRlsSpec">$soExtDbRlsSpec</paramValue>
      <depends name="genome"/>
    </step>

    <step name="extractProteins"
          stepClass="ApiCommonData::Load::WorkflowSteps::ExtractAnnotatedProteinsBySpecies">
      <paramValue name="genomeName">$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <paramValue name="ncbiTaxId">$ncbiTaxonId</paramValue>
      <paramValue name="outputFile">$proteinsFile</paramValue>
      <depends name="calcTranslatedProteins"/>
    </step>

    <step name="blastxGenomicSeqsNrdb" subflow="blast">
      <paramValue name="genomeName">$genomeName</paramValue>
      <paramValue name="queryAbbrev">genomicSeqs</paramValue>
      <paramValue name="queryFile">$genomicSeqsFile</paramValue>
      <paramValue name="queryTable">Dots.ExternalNaSequence</paramValue>
      <paramValue name="queryExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <paramValue name="subjectAbbrev">nrdb</paramValue>
      <paramValue name="subjectFile">$nrdbShortDeflineFile</paramValue>
      <paramValue name="subjectTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="subjectExtDbRlsSpec"></paramValue>
      <paramValue name="blastArgs">-cpus=4 -topcomboN=1 W=4 T=18 V=100 B=1000000 -hspmax=1000000 -gi E=1e-3 -wordmask=seg+xnu -hspsepQmax=4000 -span1</paramValue>
      <paramValue name="idRegex">gi\\|(\\d+)\\|</paramValue>
      <paramValue name="blastType">blastx</paramValue>
      <paramValue name="vendor">wu</paramValue>
      <paramValue name="loadSubjectSubset">true</paramValue>
      <depends name="extractProteins"/></paramValue>
      <depends name="extractGenomicSeqs"/></paramValue>
    </step>

    <step name="psipred" subflow="psipred">
      <paramValue name="genomeName">$genomeName</paramValue>
      <paramValue name="nrdbFile">$nrdbShortDeflineFile</paramValue>
      <paramValue name="proteinsFile">$proteinsFile</paramValue>
      <depends name="extractProteins"/>
      <depends name="nrdb"/>
    </step>

    <step name="blastpProteinsNrdb" subflow="blast">
      <paramValue name="genomeName">$genomeName</paramValue>
      <paramValue name="queryAbbrev">proteins</paramValue>
      <paramValue name="queryFile">$proteinsFile</paramValue>
      <paramValue name="queryTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="queryExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <paramValue name="subjectAbbrev">nrdb</paramValue>
      <paramValue name="subjectFile">$nrdbFile</paramValue>
      <paramValue name="subjectTable">Dots.ExternalAaSequence</paramValue>
      <paramValue name="subjectExtDbRlsSpec"></paramValue>
      <paramValue name="blastArgs">-cpus=2 -topcomboN=1 V=100 B=20 -hspmax=1000000 -gi E=1e-3 -wordmask=seg -hspsepQmax=4000 -span1</paramValue>
      <paramValue name="idRegex">gi\\|(\\d+)\\|</paramValue>
      <paramValue name="blastType">blastp</paramValue>
      <paramValue name="vendor">wu</paramValue>
      <paramValue name="loadSubjectSubset">true</paramValue>
      <depends name="extractProteins"/>
      <depends name="nrdb"/>
    </step>

    <step name="molecularWeight"
          stepClass="ApiCommonData::Load::WorkflowSteps::CalculateProteinMolWt">
      <paramValue name="genomeName">$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends name="extractProteins"/>
    </step>

    <step name="molecularWeightMinMax"
          stepClass="ApiCommonData::Load::WorkflowSteps::InsertAASeqMWMinMax">
      <paramValue name="genomeName">$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends name="extractProteins"/>
    </step>

    <step name="isoelectricPoint"
          stepClass="ApiCommonData::Load::WorkflowSteps::InsertAAiP">
      <paramValue name="genomeName">$genomeName</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <paramValue name="table">DoTS.TranslatedAASequence</paramValue>
      <depends name="extractProteins"/>
    </step>

    <step name="runTmhmm"
          stepClass="ApiCommonData::Load::WorkflowSteps::RunTmhmm">
      <paramValue name="seqFile">$proteinsFile</paramValue>
      <paramValue name="outputFile">tmhmm/$$genomeName$$Tmhmm.out</paramValue>
      <depends name="extractProteins"/>
    </step>

    <step name="insertTmhmm"
          stepClass="ApiCommonData::Load::WorkflowSteps::InsertTmhmm">
      <paramValue name="inputFile">tmhmm/$$genomeName$$Tmhmm.out</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$genomeExtDbRlsSpec</paramValue>
      <depends name="runTmhmm"/>
    </step>

  </steps>
</workflow>
