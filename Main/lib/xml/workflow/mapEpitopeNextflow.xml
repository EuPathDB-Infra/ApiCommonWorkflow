<workflowGraph name="">
   <param name="parentDataDir"/>
   <param name="datasetName"/>
   <param name="organismAbbrev"/>
   <param name="projectName"/>
   <param name="ncbiTaxon"/><!--TODO define, solved by moving the subhgraph into the organims template-->

   <constant name="dataDir">$$parentDataDir$$/iedbEpitopes</constant>
   <constant name="analysisConfig">$$parentDataDir$$/analysisConfig.xml</constant>

   <constant name="nextflowConfigFile">$$dataDir$$/nextflow.config</constant>

   <step name="makeSamplesOutputDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
   </step>

   <step name="epitopeNextflowConfig" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeEpitopeMappingNextflowConfig">
      <paramValue name="analysisDir">$$dataDir$$</paramValue>
      <paramValue name="refFasta">$$parentDataDir$$/loadGenome/AnnotatedProteins.fsa</paramValue>
      <paramValue name="peptidesTab">$$parentDataDir$$/../componentGlobal/component_epitope_IEDB_RSRC/iedb.tab</paramValue>
      <paramValue name="ncbiTaxon">$$ncbiTaxon$$</paramValue>
      <paramValue name="peptideMatchResults">PeptideMatches.txt</paramValue>
      <paramValue name="clusterResultDir">$$parentDataDir$$/results</paramValue>
      <paramValue name="peptidesFilteredBySpeciesFasta">PeptidesFilteredBySpecies.fasta</paramValue>
      <paramValue name="peptideMatchBlastCombinedResults">peptideMatchBlastCombinedResults.txt</paramValue>
      <paramValue name="configFileName">$$nextflowConfigFile$$</paramValue>

      <depends name="makeSamplesOutputDir"/>
   </step>


   <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
	<paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      	<depends name="epitopeNextflowConfig"/>
   </step>

   <step name="runEpitopeMapping" stepClass="ReFlow::StepClasses::RunAndMonitorNextflow">
     	<paramValue name="workingDir">$$dataDir$$</paramValue>
      	<paramValue name="resultsDir">$$dataDir$$/results</paramValue>
      	<paramValue name="nextflowConfigFile">$$dataDir$$/nextflow.config</paramValue>
      	<paramValue name="nextflowWorkflow">VEuPathDB/iedb-epitope-mapping-nextflow</paramValue>
      	<paramValue name="isGitRepo">true</paramValue>
      	<depends name="mirrorToCluster"/>
   </step>

   <step name="mirrorFromCluster" stepClass="ReFlow::StepClasses::MirrorFromComputeCluster" stepLoadTypes="fromCluster">
    	<paramValue name="fileOrDirToMirror">$$dataDir$$/results</paramValue>
   	<paramValue name="outputDir">$$dataDir$$/results</paramValue>
    	<paramValue name="outputFiles">TODO</paramValue>
    	<paramValue name="deleteAfterCopy">false</paramValue>
    	<depends name="runEpitopeMapping"/>
   </step> 


   <!-- TODO:  add here the call to the plugin -->


    <step name="loadIedbEpitopeMatches" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertAaSequenceEpitope" stepLoadTypes="plugin">
        <paramValue name="peptideResultFile">$$dataDir$$/results/peptideMatchBlastCombinedResults.txt</paramValue>
        <depends name="mirrorFromCluster"/>
    </step>



</workflowGraph>
