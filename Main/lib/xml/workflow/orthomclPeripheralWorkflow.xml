<workflowGraph name="">
  <param name="parentDataDir"/>
  <param name="residualGroupIdPrefix"/>
  <param name="oldReleasesGroupFilesDir"/>
  <param name="relativeDownloadSiteDir"/>
  <param name="relativeWebServicesDir"/>
  <param name="projectVersionForWebsiteFiles"/>
  <param name="coreProteome"/>
  <param name="coreResultsDir"/>

  <constant name="projectName">OrthoMCL</constant>
  <constant name="getPeripheralProteinsDir">$$parentDataDir$$/getPeripheralProteins</constant>
  <constant name="residualFastaFilesDir">$$getPeripheralProteinsDir$$/residualFastaFiles</constant>
  <constant name="makeResidualGroupsDir">$$parentDataDir$$/makeResidualGroups</constant>
  <constant name="residualGroupsDir">$$parentDataDir$$/residualGroups</constant>
  <constant name="peripheralDir">$$parentDataDir$$/peripheral</constant>

  <subgraph name="getPeripheralProteomes" xmlFile="generated/OrthoMCL/orthomclGetPeripheralProteins.xml">
    <paramValue name="parentDataDir">$$parentDataDir$$</paramValue>
    <paramValue name="getPeripheralProteinsDir">$$getPeripheralProteinsDir$$</paramValue>
    <paramValue name="relativeWebServicesDir">$$relativeWebServicesDir$$</paramValue>
    <paramValue name="residualFastaFilesDir">$$residualFastaFilesDir$$</paramValue>
    <paramValue name="oldReleasesGroupFilesDir">$$oldReleasesGroupFilesDir$$</paramValue>
    <paramValue name="projectName">$$projectName$$</paramValue>
  </subgraph>

  <step name="makePeripheralDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$peripheralDir$$</paramValue>
      <depends name="getPeripheralProteomes"/>
  </step>

  <step name="makePeripheralResultsDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$peripheralDir$$/results/</paramValue>
    <depends name="makePeripheralDir"/>
   </step>

  <step name="CopyAndUncompressPeripheralCacheDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyAndUncompressPeripheralCacheDir">
    <paramValue name="outputDir">$$peripheralDir$$</paramValue>
    <depends name="makePeripheralResultsDir"/>
  </step>

  <step name="CopyOutdatedOrganisms" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyOutdatedOrganisms">
    <paramValue name="outputDir">$$peripheralDir$$</paramValue>
    <depends name="CopyAndUncompressPeripheralCacheDir"/>
  </step>

  <step name="makeOrthoFinderPeripheralNextflowConfig" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeOrthoFinderPeripheralNextflowConfig">
    <paramValue name="clusterResultDir">$$peripheralDir$$/results/</paramValue>
    <paramValue name="configFileName">nextflow.config</paramValue>
    <paramValue name="analysisDir">$$peripheralDir$$</paramValue>
    <paramValue name="peripheralProteomes">$$getPeripheralProteinsDir$$/fastas.tar.gz</paramValue>
    <paramValue name="coreProteome">$$coreProteome$$</paramValue>
    <paramValue name="coreGroupsFile">$$coreResultsDir$$/reformattedGroups.txt</paramValue>
    <paramValue name="coreGroupSimilarities">$$coreResultsDir$$/groupDiamondResults</paramValue>
    <paramValue name="coreTranslateSequenceFile">$$coreResultsDir$$/diamondCache/SequenceIDs.txt</paramValue>
    <paramValue name="peripheralCacheDir">$$peripheralDir$$/peripheralCacheDir</paramValue>
    <paramValue name="outdated">$$peripheralDir$$/outdated.txt</paramValue>
    <depends name="CopyOutdatedOrganisms"/>
  </step>

  <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
    <paramValue name="fileOrDirToMirror">$$peripheralDir$$</paramValue>
    <depends name="makeOrthoFinderPeripheralNextflowConfig"/>
  </step>

  <step name="runOrthoFinderPeripheralClusterTask" stepClass="ReFlow::StepClasses::RunAndMonitorNextflowWithEntry">
    <paramValue name="workingDir">$$peripheralDir$$</paramValue>
    <paramValue name="resultsDir">$$peripheralDir$$/results</paramValue>
    <paramValue name="nextflowConfigFile">$$peripheralDir$$/nextflow.config</paramValue>
    <paramValue name="nextflowWorkflow">VEuPathDB/orthofinder-nextflow</paramValue>
    <paramValue name="isGitRepo">true</paramValue>
    <paramValue name="entry">peripheralEntry</paramValue>
    <depends name="mirrorToCluster"/>
  </step>

  <step name="mirrorFromCluster" stepClass="ReFlow::StepClasses::MirrorFromComputeCluster">
    <paramValue name="fileOrDirToMirror">$$peripheralDir$$/results</paramValue>
    <paramValue name="outputDir">$$peripheralDir$$/results</paramValue>
    <paramValue name="outputFiles"></paramValue>
    <paramValue name="deleteAfterCopy">false</paramValue>
    <depends name="runOrthoFinderPeripheralClusterTask"/>
  </step>     

  <step name="loadCoreGroups" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertCoreGroups">
    <paramValue name="groupsFile">$$peripheralDir$$/results/GroupsFile.txt</paramValue>
    <depends name="mirrorFromCluster"/>
  </step>

  <step name="loadResidualGroups" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertResidualGroups">
    <paramValue name="groupsFile">$$peripheralDir$$/results/reformattedGroups.txt</paramValue>
    <depends name="loadCoreGroups"/>
  </step>

  <step name="loadCoreGroupAASequence" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertOrthoGroupAASequence">
      <paramValue name="groupsFile">$$peripheralDir$$/results/GroupsFile.txt</paramValue>
      <depends name="loadResidualGroups"/>
  </step>

  <step name="loadResidualGroupAASequence" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertOrthoGroupAASequence">
      <paramValue name="groupsFile">$$peripheralDir$$/results/reformattedGroups.txt</paramValue>
      <depends name="loadCoreGroupAASequence"/>
  </step>

  <step name="insertOrthogroupCoreStats" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertOrthoGroupStats" stepLoadTypes="plugin">
      <paramValue name="groupStatsFile">$$peripheralDir$$/results/groupStats/core_stats.txt</paramValue>
      <paramValue name="proteinSubset">C</paramValue>
      <depends name="loadResidualGroupAASequence"/>
  </step>

  <step name="insertOrthogroupCorePeripheralStats" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertOrthoGroupStats" stepLoadTypes="plugin">
      <paramValue name="groupStatsFile">$$peripheralDir$$/results/groupStats/peripheral_stats.txt</paramValue>
      <paramValue name="proteinSubset">C+P</paramValue>
      <depends name="insertOrthogroupCoreStats"/>
  </step>

  <step name="insertOrthogroupResidualStats" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertOrthoGroupStats" stepLoadTypes="plugin">
      <paramValue name="groupStatsFile">$$peripheralDir$$/results/groupStats/residual_stats.txt</paramValue>
      <paramValue name="proteinSubset">R</paramValue>
      <depends name="insertOrthogroupCorePeripheralStats"/>
  </step>

  <step name="insertSimilarOrthologgroups" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertSimilarOrthologGroups" stepLoadTypes="plugin">
      <paramValue name="similarGroups">$$peripheralDir$$/results/similar_groups.tsv</paramValue>
      <depends name="insertOrthogroupResidualStats"/>
  </step>

</workflowGraph>
