<workflowGraph name="">
    <param name="projectName"/>
    <param name="organismAbbrev"/>
    <param name="experimentName"/>
    <param name="parentDataDir"/>
    <param name="organismResourceXmlFile"/>
    <param name="genomicSeqsFile"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="experimentResourceName"/>
    <param name="hasPairedEnds"/>
    <param name="consPercentCutoff"/>
    <param name="snpPercentCutoff"/>
    <param name="editDistance"/>
    <param name="includeIndels"/>
    <param name="relativeWebServicesDir"/>

    <constant name="dataDir">$$parentDataDir$$/$$experimentName$$</constant>
    <constant name="samplesOutputDir">$$dataDir$$/samplesOutput</constant>

    <step name="makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeSamplesOutputDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$samplesOutputDir$$</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeSamplesOutputDir"/>
    </step>

    <!--  The resource will ln -S over from manual delivery into the experimentDir -->
    <subgraph name="experiment_RSRC" xmlFile="loadResource.xml">
      <paramValue name="resourceName">$$experimentResourceName$$</paramValue>
      <paramValue name="resourceXmlFileName">$$organismResourceXmlFile$$</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <depends name="mirrorToCluster"/>
    </subgraph>


  <!--  TODO: Add workflow step to insert a study -->
  <step name="addStudy" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudy">
    <paramValue name="experimentName">$$experimentName$$</paramValue>
    <depends name="experiment_RSRC"/>
  </step>

    <subgraph name="map_SNPs" xmlFile="generated/$$projectName$$/$$organismAbbrev$$/$$experimentName$$/htsSnpSamples.xml">
       <paramValue name="projectName">$$projectName$$</paramValue>
       <paramValue name="experimentDir">$$dataDir$$</paramValue>
       <paramValue name="experimentRSRC">$$experimentResourceName$$</paramValue>
       <paramValue name="samplesOutputDir">$$dataDir$$/$$experimentName$$/samplesOutput</paramValue>
       <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
       <paramValue name="genomicSeqsFile">$$genomicSeqsFile$$</paramValue>
       <paramValue name="BWAIndexDir">$$parentDataDir$$/bwa_index/genomicIndexes</paramValue>
       <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
       <paramValue name="experimentName">$$experimentName$$</paramValue>
       <paramValue name="hasPairedEnds">$$hasPairedEnds$$</paramValue>
       <paramValue name="consPercentCutoff">$$consPercentCutoff$$</paramValue>
       <paramValue name="snpPercentCutoff">$$snpPercentCutoff$$</paramValue>
       <paramValue name="editDistance">$$editDistance$$</paramValue>
       <paramValue name="includeIndels">$$includeIndels$$</paramValue>
       <paramValue name="relativeWebServicesDir">$$relativeWebServicesDir$$</paramValue>
       <depends name="addStudy"/>
     </subgraph>
     
    <step name="document-hts_snp_experiment"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertAnalysisMethodInvocation">
      <paramValue name="method">hts_snp_experiment_MTHD</paramValue>
      <paramValue name="version">1.0</paramValue>
      <paramValue name="parameters">TODO: patch in later</paramValue>
    </step>

</workflowGraph>
