<workflowGraph name="">
    <param name="projectName"/>
    <param name="experimentDataDir"/>
    <param name="sampleName"/>
    <param name="samtoolsIndex"/> 
    <param name="chromSizesFile"/>
    <param name="genomicSeqsFile"/>
    <param name="organismAbbrev"/>
    <param name="experimentName"/>
    <param name="ploidy"/>
    <param name="gtfFile"/>
    <param name="relativeWebServicesDir"/>
    <param name="experimentDatasetName"/>
    <param name="studyName"/>
    <param name="snpsDir"/>
   
    <constant name="sampleAnalysisDir">$$experimentDataDir$$/$$organismAbbrev$$_$$experimentName$$_$$sampleName$$_copyNumberVariationSample_RSRC</constant> 

   
 <!-- The dataset loader here does not get anything from manual delivery.  It only makes rows in sres.extdb and extdbrls -->
    <subgraph name="loadCnvSample" xmlFile="loadDataset.xml">
        <paramValue name="datasetName">$$organismAbbrev$$_$$experimentName$$_$$sampleName$$_copyNumberVariationSample_RSRC</paramValue>
        <paramValue name="datasetLoaderXmlFileName">$$projectName$$/$$organismAbbrev$$/$$studyName$$.xml</paramValue>
        <paramValue name="parentDataDir">$$experimentDataDir$$</paramValue>
    </subgraph>
    
    <step name="runCufflinksForCNVs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RunCufflinksForCNVs">
        <paramValue name="genomicSeqsFile">$$genomicSeqsFile$$</paramValue>
        <paramValue name="outputDir">$$sampleAnalysisDir$$/</paramValue>
        <paramValue name="bamFile">$$snpsDir$$/$$studyName$$/analyze_$$sampleName$$/master/mainresult/result.bam</paramValue> <!--bamFile from SNPs run -->
        <paramValue name="gtfFile">$$gtfFile$$</paramValue>
        <depends name="loadCnvSample"/>
    </step>

    <step name="calculatePloidy" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CalculatePloidy">
        <paramValue name="outputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="fpkmFile">$$sampleAnalysisDir$$/Cufflinks/genes.fpkm_tracking</paramValue>
        <paramValue name="ploidy">$$ploidy$$</paramValue>
        <paramValue name="sampleName">$$sampleName$$</paramValue>
        <depends name="runCufflinksForCNVs"/>
    </step>

    <step name="calculateGeneCNVs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CalculateGeneCNVs">
        <paramValue name="outputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="fpkmFile">$$sampleAnalysisDir$$/Cufflinks/genes.fpkm_tracking</paramValue>
        <paramValue name="ploidy">$$ploidy$$</paramValue>
        <paramValue name="sampleName">$$sampleName$$</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <depends name="runCufflinksForCNVs"/>
    </step>    

    <step name="writePloidyConfigFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::WriteStudyConfig">
        <paramValue name="configOutputFile">$$sampleAnalysisDir$$/ploidyConfig.txt</paramValue>
        <paramValue name="file">$$sampleName$$_Ploidy.txt</paramValue>
        <paramValue name="analysisName">$$sampleName$$_ploidy (CNV)</paramValue>
        <paramValue name="protocolName">Ploidy</paramValue>
        <paramValue name="sourceIdType">NASequence</paramValue>
        <paramValue name="inputProtocolAppNode"></paramValue>
        <paramValue name="profileSetName">$$experimentName$$ - Ploidy</paramValue>
        <depends name="calculatePloidy"/>
    </step>

    <step name="insertPloidy" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyResults" stepLoadTypes="plugin">
        <paramValue name="inputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="configFile">$$sampleAnalysisDir$$/ploidyConfig.txt</paramValue>
        <paramValue name="extDbRlsSpec">$$experimentDatasetName$$|%</paramValue>
        <paramValue name="studyName">$$experimentName$$</paramValue>
        <depends name="writePloidyConfigFile"/>
    </step>

    <step name="writeCNVConfigFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::WriteStudyConfig">
        <paramValue name="configOutputFile">$$sampleAnalysisDir$$/geneCNVConfig.txt</paramValue>
        <paramValue name="file">$$sampleName$$_geneCNVs.txt</paramValue>
        <paramValue name="analysisName">$$sampleName$$_geneCNV (CNV)</paramValue>
        <paramValue name="protocolName">geneCNV</paramValue>
        <paramValue name="sourceIdType">gene</paramValue>
        <paramValue name="inputProtocolAppNode"></paramValue>
        <paramValue name="profileSetName">$$experimentName$$ - GeneCNV</paramValue>
        <depends name="calculateGeneCNVs"/>
    </step>

    <step name="insertGeneCNVs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyResults" stepLoadTypes="plugin">
        <paramValue name="inputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="configFile">$$sampleAnalysisDir$$/geneCNVConfig.txt</paramValue>
        <paramValue name="extDbRlsSpec">$$experimentDatasetName$$|%</paramValue>
        <paramValue name="studyName">$$experimentName$$</paramValue>
        <depends name="writeCNVConfigFile"/>
    </step>

    <step name="createBinnedCoverage" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CreateBinnedCoverageFile">
        <paramValue name="bamFile">$$snpsDir$$/$$studyName$$/analyze_$$sampleName$$/master/mainresult/result.bam</paramValue>
        <paramValue name="windowSize">1000</paramValue>
        <paramValue name="outputFile">$$sampleAnalysisDir$$/$$sampleName$$.bed</paramValue>
        <paramValue name="samtoolsIndex">$$samtoolsIndex$$</paramValue>
        <depends name="loadCnvSample"/>
    </step>

    <step name="makeNormalisedCoverageTrack" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeNormalisedCoverageTrack">
        <paramValue name="coverageFile">$$sampleAnalysisDir$$/$$sampleName$$.bed</paramValue>
        <paramValue name="ploidy">$$ploidy$$</paramValue>
        <paramValue name="sampleName">$$sampleName$$</paramValue>
        <paramValue name="outputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="chromSizesFile">$$chromSizesFile$$</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <depends name="createBinnedCoverage"/>
    </step>

    <step name="copyBigWigFilesToWebServiceDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyBigWigFilesToWebServices">
        <paramValue name="copyFromDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
        <paramValue name="experimentDatasetName">$$experimentDatasetName$$</paramValue>
        <depends name="makeNormalisedCoverageTrack"/>
    </step>
    
</workflowGraph>
