<workflowGraph name="">
    <param name="projectName"/>
    <param name="experimentDataDir"/>
    <param name="sampleName"/>
    <param name="samtoolsIndex"/> 
    <param name="chromSizesFile"/>
    <param name="genomicSeqsFile"/>
    <param name="organismAbbrev"/>
    <param name="experimentName"/>
    <param name="ploidy"/>
    <param name="gtfFile"/>
    <param name="relativeWebServicesDir"/>
    <param name="experimentDatasetName"/>
    <param name="studyName"/>
    <param name="snpsDir"/>
   
    <constant name="sampleAnalysisDir">$$experimentDataDir$$/$$organismAbbrev$$_$$experimentName$$_$$sampleName$$_copyNumberVariationSample_RSRC</constant> 


    <!-- Must link assay nodes to the CNV study -->
    <step name="addAssayProtocolAppNode" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::AddProtocolAppNodeToStudy" stepLoadTypes="plugin">
      <paramValue name="experimentName">$$organismAbbrev$$ $$studyName$$ (CNV)</paramValue>
      <paramValue name="extDbRlsSpec">$$organismAbbrev$$_$$studyName$$_$$sampleName$$_HTS_SNPSample_RSRC|dontcare</paramValue>
      <paramValue name="name">$$sampleName$$ (DNA Sequencing)</paramValue>
    </step>


    <step name="cnvWorkflowCheckpoint" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CnvWorkflowCheckpoint">
        <paramValue name="sampleName">$$sampleName$$</paramValue>
        <paramValue name="experimentName">$$experimentName$$</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <paramValue name="outputSkipIfFile">$$sampleAnalysisDir$$/doNotDoAnalysis</paramValue>
    </step>
   
 <!-- The dataset loader here does not get anything from manual delivery.  It only makes rows in sres.extdb and extdbrls -->
    <subgraph name="loadCnvSample" xmlFile="loadDataset.xml" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="datasetName">$$organismAbbrev$$_$$experimentName$$_$$sampleName$$_copyNumberVariationSample_RSRC</paramValue>
        <paramValue name="datasetLoaderXmlFileName">$$projectName$$/$$organismAbbrev$$/$$studyName$$.xml</paramValue>
        <paramValue name="parentDataDir">$$experimentDataDir$$</paramValue>
        <depends name="cnvWorkflowCheckpoint"/>
    </subgraph>

    <step name="mirrorSampleAnalysisDirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="fileOrDirToMirror">$$sampleAnalysisDir$$</paramValue>
        <depends name="loadCnvSample"/>
    </step>

    <step name="mirrorBamFileToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="fileOrDirToMirror">$$snpsDir$$/$$studyName$$/analyze_$$sampleName$$/master</paramValue>
        <depends name="cnvWorkflowCheckpoint"/>
    </step>

    <step name="makeCNVTaskInputDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeCNVTaskInputDir" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="taskInputDir">$$sampleAnalysisDir$$/input</paramValue>
        <paramValue name="genomicSeqsFile">$$genomicSeqsFile$$</paramValue>
        <paramValue name="gtfFile">$$gtfFile$$</paramValue>
        <paramValue name="bamFile">$$snpsDir$$/$$studyName$$/analyze_$$sampleName$$/master/mainresult/result.bam</paramValue>
        <paramValue name="samtoolsIndex">$$samtoolsIndex$$</paramValue>
        <paramValue name="sampleName">$$sampleName$$</paramValue>
        <paramValue name="window">1000</paramValue>
        <depends name="loadCnvSample"/>
    </step>

    <step name="mirrorTaskInputDirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="fileOrDirToMirror">$$sampleAnalysisDir$$/input</paramValue>
        <depends name="makeCNVTaskInputDir"/>
        <depends name="mirrorSampleAnalysisDirToCluster"/>
    </step>

    <step name="runClusterTask" stepClass="ReFlow::StepClasses::RunAndMonitorDistribJob" stepLoadTypes="cluster" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="taskInputDir">$$sampleAnalysisDir$$/input</paramValue>
        <paramValue name="numNodes">1</paramValue>
        <paramValue name="maxMemoryGigs">8</paramValue>
        <paramValue name="processorsPerNode">4</paramValue>
        <depends name="mirrorTaskInputDirToCluster"/>
        <depends name="mirrorBamFileToCluster"/>
    </step>

    <step name="mirrorCufflinksOutputFromCluster" stepClass="ReFlow::StepClasses::MirrorFromComputeCluster" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="fileOrDirToMirror">$$sampleAnalysisDir$$/master</paramValue>
        <paramValue name="outputDir">$$sampleAnalysisDir$$/master/mainresult/Cufflinks</paramValue>
        <paramValue name="outputFiles">$$sampleAnalysisDir$$/master/mainresult/Cufflinks/genes.fpkm_tracking,$$sampleAnalysisDir$$/master/mainresult/$$sampleName$$.bed</paramValue>
        <paramValue name="deleteAfterCopy">true</paramValue>
        <depends name="runClusterTask"/>
    </step>

    <step name="calculatePloidy" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CalculatePloidy" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="outputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="fpkmFile">$$sampleAnalysisDir$$/master/mainresult/Cufflinks/genes.fpkm_tracking</paramValue>
        <paramValue name="ploidy">$$ploidy$$</paramValue>
        <paramValue name="sampleName">$$sampleName$$</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <depends name="mirrorCufflinksOutputFromCluster"/>
    </step>

    <step name="calculateGeneCNVs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CalculateGeneCNVs" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="outputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="fpkmFile">$$sampleAnalysisDir$$/master/mainresult/Cufflinks/genes.fpkm_tracking</paramValue>
        <paramValue name="ploidy">$$ploidy$$</paramValue>
        <paramValue name="sampleName">$$sampleName$$</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <depends name="mirrorCufflinksOutputFromCluster"/>
    </step>    

    <step name="writePloidyConfigFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::WriteStudyConfig" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="configOutputFile">$$sampleAnalysisDir$$/ploidyConfig.txt</paramValue>
        <paramValue name="file">$$sampleName$$_Ploidy.txt</paramValue>
        <paramValue name="analysisName">$$sampleName$$_ploidy (CNV)</paramValue>
        <paramValue name="protocolName">Ploidy</paramValue>
        <paramValue name="sourceIdType">NASequence</paramValue>
        <paramValue name="inputProtocolAppNode">$$sampleName$$ (DNA Sequencing)</paramValue>
        <paramValue name="profileSetName">$$organismAbbrev$$ $$studyName$$ - Ploidy</paramValue>
        <depends name="calculatePloidy"/>
    </step>

    <step name="insertPloidy" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyResults" stepLoadTypes="plugin" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="inputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="configFile">$$sampleAnalysisDir$$/ploidyConfig.txt</paramValue>
        <paramValue name="extDbRlsSpec">$$experimentDatasetName$$|%</paramValue>
        <paramValue name="studyName">$$organismAbbrev$$ $$studyName$$ (CNV)</paramValue>
        <depends name="writePloidyConfigFile"/>
    </step>

    <step name="writeCNVConfigFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::WriteStudyConfig" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="configOutputFile">$$sampleAnalysisDir$$/geneCNVConfig.txt</paramValue>
        <paramValue name="file">$$sampleName$$_geneCNVs.txt</paramValue>
        <paramValue name="analysisName">$$sampleName$$_geneCNV (CNV)</paramValue>
        <paramValue name="protocolName">geneCNV</paramValue>
        <paramValue name="sourceIdType">gene</paramValue>
        <paramValue name="inputProtocolAppNode">$$sampleName$$ (DNA Sequencing)</paramValue>
        <paramValue name="profileSetName">$$organismAbbrev$$ $$studyName$$ - GeneCNV</paramValue>
        <depends name="calculateGeneCNVs"/>
    </step>

    <step name="insertGeneCNVs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyResults" stepLoadTypes="plugin" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="inputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="configFile">$$sampleAnalysisDir$$/geneCNVConfig.txt</paramValue>
        <paramValue name="extDbRlsSpec">$$experimentDatasetName$$|%</paramValue>
        <paramValue name="studyName">$$organismAbbrev$$ $$studyName$$ (CNV)</paramValue>
        <depends name="writeCNVConfigFile"/>
    </step>

    <step name="makeNormalisedCoverageTrack" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeNormalisedCoverageTrack" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="coverageFile">$$sampleAnalysisDir$$/master/mainresult/$$sampleName$$.bed</paramValue>
        <paramValue name="ploidy">$$ploidy$$</paramValue>
        <paramValue name="sampleName">$$sampleName$$</paramValue>
        <paramValue name="outputDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="chromSizesFile">$$chromSizesFile$$</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <depends name="mirrorCufflinksOutputFromCluster"/>
    </step>

    <step name="copyBigWigFilesToWebServiceDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyBigWigFilesToWebServices" skipIfFile="$$sampleAnalysisDir$$/doNotDoAnalysis">
        <paramValue name="copyFromDir">$$sampleAnalysisDir$$</paramValue>
        <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
        <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
        <paramValue name="experimentDatasetName">$$experimentDatasetName$$</paramValue>
        <depends name="makeNormalisedCoverageTrack"/>
    </step>
    
</workflowGraph>
