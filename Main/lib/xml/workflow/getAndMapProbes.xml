<workflowGraph name="getAndMapProbes">
    <param name="parentDataDir"/>
    <param name="probeResourceName"/>
    <param name="organismResourceXmlFile"/>
    <param name="bowtieGenomicIndexDir"/>
    <param name="bowtieTranscriptIndexDir"/>
    <param name="ssaGeneModelFile"/>
    <param name="genomicSeqsFile"/>
    <param name="genomicSeqsDir"/>
    <param name="chipProbeExtDbRlsSpec"/>
    <param name="isOneChannel"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="organismFullName"/>
    <param name="readLength"/>
    <param name="maxIntronSize"/>
    <param name="runParse2fasta"/>
    <param name="genomicSeqsFileForSsa"/>
    <param name="nonUniqueMappingSuppressLimits"/>
    <param name="dnaHybridazation"/>


    <constant name="dataDir">$$parentDataDir$$/getAndMap_$$probeResourceName$$</constant>
    <constant name="outputUniqueFile">$$dataDir$$/uniqueMapping.txt</constant>
    <constant name="outputNonUniqueFile">$$dataDir$$/nonUniqueMapping.txt</constant>

    <step name="makeDataDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="mirrorToCluster" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MirrorToComputeCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <subgraph name="probe_RSRC" xmlFile="loadResource.xml">
      <paramValue name="resourceName">$$probeResourceName$$</paramValue>
      <paramValue name="resourceXmlFileName">$$organismResourceXmlFile$$</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <depends name="makeDataDir"/>
    </subgraph>

    <step name="runParse2fasta" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RunParse2fasta" includeIf="$$runParse2fasta$$">
      <paramValue name="shortSeqsFile">$$dataDir$$/$$probeResourceName$$/final/probes.fsa</paramValue>
      <depends name="probe_RSRC"/>
    </step>

    <subgraph name="alignProbesToGenome"  xmlFile="ssa.xml">
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="bowtieGenomicIndexDir">$$bowtieGenomicIndexDir$$</paramValue>
      <paramValue name="bowtieTranscriptIndexDir">$$bowtieTranscriptIndexDir$$</paramValue>
      <paramValue name="geneModelFile">$$ssaGeneModelFile$$</paramValue>
      <paramValue name="useTranscripts">true</paramValue>
      <paramValue name="shortSeqsFile">$$dataDir$$/$$probeResourceName$$/final/probes.fsa</paramValue>
      <paramValue name="genomicSeqsFile">$$genomicSeqsFile$$</paramValue>
      <paramValue name="genomicSeqsDir">$$genomicSeqsDir$$</paramValue>
      <paramValue name="outputUniqueFile">$$outputUniqueFile$$</paramValue>
      <paramValue name="outputNonUniqueFile">$$outputNonUniqueFile$$</paramValue>
      <paramValue name="isChipSeq">false</paramValue>
      <paramValue name="readType">single</paramValue>
      <paramValue name="readLength">$$readLength$$</paramValue>
      <paramValue name="maxIntronSize">$$maxIntronSize$$</paramValue>
      <paramValue name="genomicSeqsFileForSsa">$$genomicSeqsFileForSsa$$</paramValue>
      <paramValue name="">$$nonUniqueMappingSuppressLimits$$</paramValue>
      <depends name="runParse2fasta"/>
      <depends name="mirrorToCluster"/>
    </subgraph>


    <step name="revertProbeSeqId" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::RevertProbeSeqId" includeIf="$$runParse2fasta$$">
      <paramValue name="shortSeqsFile">$$dataDir$$/$$probeResourceName$$/final/probes.fsa</paramValue>
      <paramValue name="originalShortSeqsFile">$$dataDir$$/$$probeResourceName$$/final/probes.fsa.org</paramValue>
      <paramValue name="inputUniqueFile">$$outputUniqueFile$$</paramValue>
      <paramValue name="inputNonUniqueFile">$$outputNonUniqueFile$$</paramValue>
      <depends name="alignProbesToGenome"/>
    </step>

    <step name="excludeMultiExonHits" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::ExcludeMultiExonHits" includeIf="$$dnaHybridazation$$">
      <paramValue name="inputUniqueFile">$$outputUniqueFile$$</paramValue>
      <paramValue name="inputNonUniqueFile">$$outputNonUniqueFile$$</paramValue>
      <depends name="revertProbeSeqId"/>
    </step>

    <step name="makeProbeGenomeMappingGffFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::GenerateGenomeMappingGff">
      <paramValue name="inputUniqueFile">$$outputUniqueFile$$</paramValue>
      <paramValue name="inputNonUniqueFile">$$outputNonUniqueFile$$</paramValue>
      <paramValue name="outputFile">$$dataDir$$/genomeMapping.gff</paramValue>
      <paramValue name="allowedMismatches">1</paramValue>
      <depends name="revertProbeSeqId"/>
      <depends name="excludeMultiExonHits"/>
    </step>

    <step name="loadProbeGenomeMapping" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::LoadChIPChipPeakFeature" stepLoadTypes="plugin">
      <paramValue name="inputFile">$$dataDir$$/genomeMapping.gff</paramValue>
      <paramValue name="genomeExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="extDbRlsSpec">$$chipProbeExtDbRlsSpec$$</paramValue>
      <paramValue name="substepClass">ExternalNASequence</paramValue>
      <paramValue name="defaultOrg">$$organismFullName$$</paramValue>
      <paramValue name="isfMappingFileRelToGusHome">lib/xml/isf/PlasmoDB/plasmoProbeFeature2gus.xml</paramValue>
      <paramValue name="soVersion">@@SO_VER@@</paramValue>
      <depends name="makeProbeGenomeMappingGffFile"/>
    </step>

    <step name="makeProbeGeneMappingFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeProbeGeneMappingFile">
      <paramValue name="outputFile">$$dataDir$$/geneProbeMapping.txt</paramValue>
      <paramValue name="extDbRlsSpec">$$chipProbeExtDbRlsSpec$$</paramValue>
      <paramValue name="featureType">ArrayElementFeature</paramValue>
      <depends name="loadProbeGenomeMapping"/>
    </step>

    <step name="makeCdfFileForAffyArray" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeCdfFileForAffyArray" includeIf="$$isOneChannel$$">
      <paramValue name="gene2probesInputFile">$$dataDir$$/geneProbeMapping.txt</paramValue>
      <paramValue name="probename2sequenceInputFile">$$dataDir$$/$$probeResourceName$$/final/probename2sequence.tab</paramValue>
      <paramValue name="cdfFile">$$dataDir$$/$$probeResourceName$$/final/affyArray.cdf</paramValue>
      <depends name="makeProbeGeneMappingFile"/>
    </step>

</workflowGraph>
